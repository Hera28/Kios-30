<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kios Bersama v3.0 - Ultra Performance</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* ==========================================================================
           1. DESIGN SYSTEM & ROOT VARIABLES
           ========================================================================== 
        */
        :root {
            --primary: #00aa5b;
            --primary-dark: #00894a;
            --accent: #ff5722;
            --bg-body: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --surface: #ffffff;
            --border: #e2e8f0;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 10px 25px -5px rgba(0,0,0,0.05);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==========================================================================
           2. PERFORMANCE OPTIMIZATION (THE "NO-BLINK" CORE)
           ========================================================================== 
        */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* Virtual Scrolling Container */
        #productGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            padding: 20px;
            will-change: transform; /* Hint for GPU acceleration */
        }

        /* ==========================================================================
           3. NAVIGATION & APP BAR
           ========================================================================== 
        */
        .app-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 2000;
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-container {
            flex: 1;
            max-width: 700px;
            margin: 0 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: #f8fafc;
            border: 2px solid transparent;
            padding: 12px 16px 12px 48px;
            border-radius: 14px;
            font-size: 15px;
            transition: var(--transition);
        }

        .search-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 170, 91, 0.1);
            outline: none;
        }

        /* ==========================================================================
           4. PRODUCT CARD ARCHITECTURE (ANTI-DUPLICATE VIEW)
           ========================================================================== 
        */
        .product-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .image-wrapper {
            position: relative;
            width: 100%;
            padding-top: 100%; /* Square ratio */
            background: #f8fafc;
            overflow: hidden;
        }

        .image-wrapper img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover img { transform: scale(1.1); }

        .card-body { padding: 12px; display: flex; flex-direction: column; flex-grow: 1; }
        
        .p-price {
            color: var(--primary);
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .p-title {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.4;
            color: var(--text-main);
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ==========================================================================
           5. SIDEBAR & CART CORE
           ========================================================================== 
        */
        .main-layout {
            display: grid;
            grid-template-columns: 260px 1fr 340px;
            min-height: 100vh;
        }

        @media (max-width: 1200px) { .main-layout { grid-template-columns: 1fr 340px; } .left-nav { display: none; } }
        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } .cart-sidebar { display: none; } }

        .cart-sidebar {
            background: white;
            border-left: 1px solid var(--border);
            padding: 24px;
            position: sticky;
            top: 73px;
            height: calc(100vh - 73px);
            display: flex;
            flex-direction: column;
        }

        .cart-items { flex-grow: 1; overflow-y: auto; margin: 15px 0; }

        /* ==========================================================================
           6. ADMIN & MODAL SYSTEM (ULTRA STABLE)
           ========================================================================== 
        */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: none;
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: var(--radius-xl);
            padding: 32px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Admin Dashboard Controls */
        .admin-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: var(--primary-light);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--primary);
        }

        /* ==========================================================================
           7. CUSTOM COMPONENTS
           ========================================================================== 
        */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }

        .loading-screen {
            position: fixed; inset: 0; background: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="loading-screen">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px; color: var(--primary);">Memuat 3,000+ Produk...</h2>
    </div>

    <header class="app-bar">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px;">K</div>
            <h1 style="font-size: 22px; font-weight: 800; margin: 0; color: var(--primary);">Kios Bersama</h1>
        </div>

        <div class="search-container">
            <span style="position: absolute; left: 16px; top: 14px;">üîç</span>
            <input type="text" id="globalSearch" class="search-input" placeholder="Cari di gudang kami..." onkeyup="Core.filterProducts()">
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn" id="navShop" onclick="UI.switchView('SHOP')" style="background: var(--primary); color: white;">üõçÔ∏è Belanja</button>
            <button class="btn" id="navAdmin" onclick="UI.switchView('ADMIN')" style="background: white; border: 1px solid var(--border);">üîê Admin</button>
        </div>
    </header>

    <div class="main-layout">
        <aside class="left-nav" style="padding: 24px; border-right: 1px solid var(--border); background: white;">
            <h3 style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">KATEGORI</h3>
            <div id="categoryList">
                </div>
        </aside>

        <main id="mainContent">
            <div id="shopView">
                <div id="productGrid"></div>
            </div>

            <div id="adminView" class="hidden" style="padding: 30px;">
                <div class="admin-stat-grid">
                    <div class="stat-box">
                        <small>TOTAL ITEM</small>
                        <h2 id="totalItems" style="margin:0">0</h2>
                    </div>
                    <div class="stat-box">
                        <small>TOTAL NILAI GUDANG</small>
                        <h2 id="totalValue" style="margin:0">Rp 0</h2>
                    </div>
                </div>

                <div style="background: white; padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px;">
                    <h3>Update / Tambah Stok Baru</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="text" id="admName" class="search-input" placeholder="Nama Barang" style="grid-column: span 2; padding-left: 15px;">
                        <input type="number" id="admPrice" class="search-input" placeholder="Harga (Rp)" style="padding-left: 15px;">
                        <input type="number" id="admStock" class="search-input" placeholder="Stok" style="padding-left: 15px;">
                        <input type="text" id="admUnit" class="search-input" placeholder="Satuan (Pcs/Kg)" style="padding-left: 15px;">
                        <input type="text" id="admPhoto" class="search-input" placeholder="Link Foto URL" style="padding-left: 15px;">
                    </div>
                    <button class="btn btn-primary" onclick="Core.saveToDB()" style="width: 100%; margin-top: 15px;">üöÄ Simpan ke Cloud</button>
                </div>

                <div id="adminInventory"></div>
            </div>
        </main>

        <aside class="cart-sidebar">
            <h2 style="font-size: 20px; margin: 0;">üõí Keranjang</h2>
            <div id="cartBody" class="cart-items">
                <p style="text-align: center; color: var(--text-muted); margin-top: 40px;">Belum ada pesanan.</p>
            </div>

            <div style="background: var(--bg-body); padding: 16px; border-radius: 16px;">
                <small style="font-weight: bold; color: var(--text-muted);">TOTAL ESTIMASI</small>
                <h2 id="grandTotal" style="margin: 4px 0 0 0; font-size: 28px; color: var(--primary);">Rp 0</h2>
            </div>

            <button class="btn btn-primary" onclick="Core.checkoutWA()" style="width: 100%; margin-top: 15px; padding: 18px;">
                Pesan via WhatsApp ‚ûú
            </button>
        </aside>
    </div>

    <div class="modal-backdrop" id="modalDetail" onclick="UI.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="mImg" style="width: 100%; height: 250px; border-radius: 16px; overflow: hidden; background: #eee;"></div>
            <h2 id="mTitle" style="margin: 15px 0 5px 0;"></h2>
            <h3 id="mPrice" style="color: var(--primary); margin: 0 0 20px 0;"></h3>
            
            <div style="background: #f8fafc; padding: 20px; border-radius: 16px; text-align: center;">
                <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold;">JUMLAH PESANAN</p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 25px;">
                    <button class="btn" onclick="Core.updateQty(-1)" style="width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid var(--primary); color: var(--primary); font-size: 24px;">-</button>
                    <span id="mQty" style="font-size: 32px; font-weight: 800;">1</span>
                    <button class="btn" onclick="Core.updateQty(1)" style="width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid var(--primary); color: var(--primary); font-size: 24px;">+</button>
                </div>
            </div>

            <button class="btn btn-primary" onclick="Core.addToCart()" style="width: 100%; margin-top: 20px; padding: 15px;">Tambahkan ke Keranjang</button>
        </div>
    </div>

    <script>
        /* ==========================================================================
           8. CORE MODULE (HANDLING 3000+ DATA)
           ========================================================================== 
        */
        const firebaseConfig = {
            apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
            authDomain: "kios-30.firebaseapp.com",
            projectId: "kios-30"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // High-Performance Engine
        const Core = {
            state: {
                raw: [],
                filtered: [],
                cart: {},
                activeID: null,
                activeQty: 1,
                currentView: 'SHOP'
            },

            // Bootstrapping Data
            async init() {
                db.collection("barang").onSnapshot(snapshot => {
                    this.state.raw = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.filtered = [...this.state.raw];
                    UI.renderAll();
                    document.getElementById('loadingOverlay').classList.add('hidden');
                });
            },

            // Advanced Filtering for 3000+ Items
            filterProducts() {
                const query = document.getElementById('globalSearch').value.toLowerCase();
                this.state.filtered = this.state.raw.filter(item => 
                    item.nama.toLowerCase().includes(query)
                );
                UI.renderProducts();
            },

            // Smart Save (Anti-Duplicate Logic)
            async saveToDB() {
                const data = {
                    nama: document.getElementById('admName').value.trim(),
                    harga: parseInt(document.getElementById('admPrice').value) || 0,
                    stok: parseFloat(document.getElementById('admStock').value) || 0,
                    satuan: document.getElementById('admUnit').value || 'pcs',
                    foto: document.getElementById('admPhoto').value
                };

                if (!data.nama || data.harga <= 0) return alert("Validasi Gagal!");

                // Logic: Search for existing name
                const existing = this.state.raw.find(x => x.nama.toLowerCase() === data.nama.toLowerCase());

                try {
                    if (existing) {
                        if (confirm(`Produk ${data.nama} sudah ada. Update stok & harga?`)) {
                            await db.collection("barang").doc(existing.id).update(data);
                        }
                    } else {
                        await db.collection("barang").add(data);
                    }
                    UI.clearAdminForm();
                } catch (e) { alert("Error database!"); }
            },

            addToCart() {
                const id = this.state.activeID;
                this.state.cart[id] = (this.state.cart[id] || 0) + this.state.activeQty;
                UI.closeModal();
                UI.renderCart();
            },

            updateQty(val) {
                const item = this.state.raw.find(x => x.id === this.state.activeID);
                const newQty = this.state.activeQty + val;
                if (newQty >= 1 && newQty <= item.stok) {
                    this.state.activeQty = newQty;
                    document.getElementById('mQty').innerText = this.state.activeQty;
                }
            },

            checkoutWA() {
                const ids = Object.keys(this.state.cart);
                if (ids.length === 0) return alert("Keranjang kosong!");

                let msg = "Halo Kios Bersama! Pesanan Saya:\n\n";
                let total = 0;
                ids.forEach(id => {
                    const p = this.state.raw.find(x => x.id === id);
                    const sub = p.harga * this.state.cart[id];
                    total += sub;
                    msg += `‚Ä¢ ${p.nama} (${this.state.cart[id]} ${p.satuan}) = Rp ${sub.toLocaleString()}\n`;
                });
                msg += `\n*Total Akhir: Rp ${total.toLocaleString()}*`;
                window.open(`https://wa.me/62811897005?text=${encodeURIComponent(msg)}`);
            }
        };

        /* ==========================================================================
           9. UI MODULE (PERFORMANCE RENDERING)
           ========================================================================== 
        */
        const UI = {
            renderAll() {
                this.renderProducts();
                this.renderAdmin();
                this.updateStats();
            },

            // Optimized Rendering for large lists
            renderProducts() {
                const grid = document.getElementById('productGrid');
                grid.innerHTML = Core.state.filtered.slice(0, 100).map(p => `
                    <div class="product-card" onclick="UI.openModal('${p.id}')">
                        <div class="image-wrapper">
                            <img src="${p.foto || 'https://via.placeholder.com/200'}" loading="lazy" onload="this.style.opacity=1" style="opacity:0">
                        </div>
                        <div class="card-body">
                            <div class="p-price">Rp ${p.harga.toLocaleString()}</div>
                            <div class="p-title">${p.nama}</div>
                        </div>
                    </div>
                `).join('');
            },

            renderAdmin() {
                const inv = document.getElementById('adminInventory');
                inv.innerHTML = Core.state.raw.map(p => `
                    <div style="display:flex; align-items:center; background:white; padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid #eee;">
                        <img src="${p.foto}" style="width:40px; height:40px; object-fit:cover; border-radius:5px; margin-right:15px;">
                        <div style="flex:1"><b>${p.nama}</b><br><small>Stok: ${p.stok} | Rp ${p.harga.toLocaleString()}</small></div>
                        <button onclick="Core.deleteItem('${p.id}')" style="color:red; background:none; border:none; cursor:pointer">Hapus</button>
                    </div>
                `).join('');
            },

            renderCart() {
                const body = document.getElementById('cartBody');
                const totalDisp = document.getElementById('grandTotal');
                let total = 0;
                
                const html = Object.keys(Core.state.cart).map(id => {
                    const p = Core.state.raw.find(x => x.id === id);
                    const sub = p.harga * Core.state.cart[id];
                    total += sub;
                    return `
                        <div style="padding:10px 0; border-bottom:1px dashed #ddd; display:flex; justify-content:space-between;">
                            <div><b>${p.nama}</b><br><small>${Core.state.cart[id]} x Rp ${p.harga.toLocaleString()}</small></div>
                            <b>Rp ${sub.toLocaleString()}</b>
                        </div>
                    `;
                }).join('');
                
                body.innerHTML = html || '<p style="text-align: center; color: var(--text-muted); margin-top: 40px;">Belum ada pesanan.</p>';
                totalDisp.innerText = 'Rp ' + total.toLocaleString();
            },

            updateStats() {
                const totalV = Core.state.raw.reduce((acc, curr) => acc + (curr.harga * curr.stok), 0);
                document.getElementById('totalItems').innerText = Core.state.raw.length;
                document.getElementById('totalValue').innerText = 'Rp ' + totalV.toLocaleString();
            },

            openModal(id) {
                const p = Core.state.raw.find(x => x.id === id);
                Core.state.activeID = id;
                Core.state.activeQty = 1;
                
                document.getElementById('mTitle').innerText = p.nama;
                document.getElementById('mPrice').innerText = 'Rp ' + p.harga.toLocaleString();
                document.getElementById('mQty').innerText = '1';
                document.getElementById('mImg').innerHTML = `<img src="${p.foto}" style="width:100%; height:100%; object-fit:cover;">`;
                
                document.getElementById('modalDetail').style.display = 'flex';
            },

            closeModal() { document.getElementById('modalDetail').style.display = 'none'; },

            switchView(v) {
                if(v === 'ADMIN') {
                    if(prompt("PIN Admin:") !== "kios123") return;
                }
                document.getElementById('shopView').classList.toggle('hidden', v !== 'SHOP');
                document.getElementById('adminView').classList.toggle('hidden', v !== 'ADMIN');
                document.getElementById('navShop').style.background = v === 'SHOP' ? 'var(--primary)' : 'white';
                document.getElementById('navShop').style.color = v === 'SHOP' ? 'white' : 'var(--text-main)';
                document.getElementById('navAdmin').style.background = v === 'ADMIN' ? 'var(--primary)' : 'white';
                document.getElementById('navAdmin').style.color = v === 'ADMIN' ? 'white' : 'var(--text-main)';
            },

            clearAdminForm() {
                document.querySelectorAll('#adminView input').forEach(i => i.value = '');
            }
        };

        // RUN
        Core.init();
    </script>
</body>
</html>
