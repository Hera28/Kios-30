<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kios Bersama</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --green: #00aa5b; }
        body { margin: 0; font-family: sans-serif; background: #f4f7f6; }
        
        header { background: #fff; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; }
        .search-box { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; }

        .main { max-width: 1200px; margin: 20px auto; padding: 0 15px; display: flex; gap: 20px; }
        .product-area { flex: 3; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .card { background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #eee; cursor: pointer; }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; background: #f9f9f9; }
        .card b { display: block; margin-top: 8px; font-size: 14px; height: 34px; overflow: hidden; }
        .card .p { color: var(--green); font-weight: bold; font-size: 16px; margin: 5px 0; }
        .card .s { font-size: 11px; color: #888; }

        .sidebar { flex: 1; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #ddd; height: fit-content; position: sticky; top: 80px; }
        .btn-wa { background: var(--green); color: #fff; border: none; width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index: 1000; }
        .modal-content { background:#fff; width:90%; max-width:400px; padding:25px; border-radius:20px; }
        
        .counter { display: flex; align-items: center; gap: 15px; margin: 20px 0; justify-content: center; }
        .c-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--green); background: #fff; color: var(--green); font-weight: bold; cursor: pointer; }
        
        .subtotal { display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; border-top: 1px solid #eee; padding-top: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 900; color: var(--green); font-size: 20px;">KIOS BERSAMA</div>
    <input type="text" class="search-box" id="cari" placeholder="Cari produk..." onkeyup="tampil()">
</header>

<div class="main">
    <div class="product-area">
        <div style="margin-bottom: 15px;">
            <button onclick="pindah('B')" style="padding:8px 15px; cursor:pointer">Belanja</button>
            <button onclick="pindah('A')" style="padding:8px 15px; cursor:pointer">Admin</button>
        </div>
        
        <div id="viewB">
            <div class="grid" id="gridB"></div>
        </div>

        <div id="viewA" class="hidden">
            <div style="background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #ddd">
                <h3>Tambah Barang</h3>
                <input id="inN" placeholder="Nama Produk" style="width:100%; margin-bottom:10px; padding:8px">
                <input id="inH" type="number" placeholder="Harga" style="width:48%; padding:8px">
                <input id="inS" type="number" placeholder="Stok" style="width:48%; padding:8px">
                <input id="inSat" placeholder="Satuan" style="width:100%; margin:10px 0; padding:8px">
                <input id="inF" placeholder="Link Foto" style="width:100%; margin-bottom:10px; padding:8px">
                <button onclick="simpan()" style="width:100%; padding:10px; background:var(--green); color:#fff; border:none; border-radius:8px">Simpan</button>
            </div>
            <div id="gridA"></div>
        </div>
    </div>

    <div class="sidebar">
        <h3>Keranjang</h3>
        <div id="list-keranjang">Kosong</div>
        <hr>
        <div style="display:flex; justify-content:space-between">
            <span>Total:</span>
            <b id="total-harga">Rp 0</b>
        </div>
        <button class="btn-wa" onclick="checkout()">Pesan ke WA</button>
    </div>
</div>

<div id="myModal" class="modal" onclick="tutup()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="popNama"></h3>
        <p id="popStok"></p>
        <div class="counter">
            <button class="c-btn" onclick="ubahQty(-1)">-</button>
            <div id="qVal" style="font-weight:bold; font-size:20px">1</div>
            <button class="c-btn" onclick="ubahQty(1)">+</button>
        </div>
        <div class="subtotal">
            <span>Subtotal</span>
            <span id="popSub">Rp 0</span>
        </div>
        <button class="btn-wa" style="margin-top:20px" onclick="keKeranjang()">+ Keranjang</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
    authDomain: "kios-30.firebaseapp.com",
    projectId: "kios-30"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let SEMUA_BARANG = [];
let KERANJANG = {};
let idSkrg = null;

// Ambil data murni sesuai field Firebase: nama, harga, stok, satuan, foto
db.collection("barang").onSnapshot(snap => {
    SEMUA_BARANG = [];
    snap.forEach(doc => {
        let d = doc.data();
        if(d.nama) {
            SEMUA_BARANG.push({
                id: doc.id,
                nama: d.nama,
                harga: d.harga || 0,
                stok: d.stok || 0,
                satuan: d.satuan || "pcs",
                foto: d.foto || ""
            });
        }
    });
    tampil();
});

function tampil() {
    const gb = document.getElementById("gridB");
    const ga = document.getElementById("gridA");
    const cari = document.getElementById("cari").value.toLowerCase();
    gb.innerHTML = ""; ga.innerHTML = "";

    SEMUA_BARANG.forEach(it => {
        if(it.nama.toLowerCase().includes(cari)) {
            gb.innerHTML += `
                <div class="card" onclick="bukaModal('${it.id}')">
                    <img src="${it.foto || ''}" onerror="this.src='https://via.placeholder.com/150'">
                    <b>${it.nama}</b>
                    <div class="p">Rp ${it.harga.toLocaleString()}</div>
                    <div class="s">Stok: ${it.stok} ${it.satuan}</div>
                </div>`;
            ga.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee">${it.nama} <button onclick="hapus('${it.id}')" style="color:red; float:right">Hapus</button></div>`;
        }
    });
}

function bukaModal(id) {
    idSkrg = id;
    let it = SEMUA_BARANG.find(x => x.id === id);
    document.getElementById("popNama").innerText = it.nama;
    document.getElementById("popStok").innerText = "Tersedia: " + it.stok;
    document.getElementById("qVal").innerText = 1;
    hitungSub();
    document.getElementById("myModal").style.display = "flex";
}

function ubahQty(n) {
    let q = parseInt(document.getElementById("qVal").innerText);
    let it = SEMUA_BARANG.find(x => x.id === idSkrg);
    let baru = q + n;
    if(baru >= 1 && baru <= it.stok) {
        document.getElementById("qVal").innerText = baru;
        hitungSub();
    }
}

function hitungSub() {
    let it = SEMUA_BARANG.find(x => x.id === idSkrg);
    let q = parseInt(document.getElementById("qVal").innerText);
    document.getElementById("popSub").innerText = "Rp " + (it.harga * q).toLocaleString();
}

function keKeranjang() {
    let q = parseInt(document.getElementById("qVal").innerText);
    KERANJANG[idSkrg] = (KERANJANG[idSkrg] || 0) + q;
    updateSide();
    tutup();
}

function updateSide() {
    let list = document.getElementById("list-keranjang");
    let tot = 0; list.innerHTML = "";
    for(let id in KERANJANG) {
        let it = SEMUA_BARANG.find(x => x.id === id);
        tot += it.harga * KERANJANG[id];
        list.innerHTML += `<div>${it.nama} (x${KERANJANG[id]})</div>`;
    }
    document.getElementById("total-harga").innerText = "Rp " + tot.toLocaleString();
}

function checkout() {
    let text = "Halo Kios Bersama, saya mau pesan:\n";
    for(let id in KERANJANG) {
        let it = SEMUA_BARANG.find(x => x.id === id);
        text += `- ${it.nama} (x${KERANJANG[id]})\n`;
    }
    window.open("https://wa.me/62811897005?text=" + encodeURIComponent(text));
}

function simpan() {
    let n = document.getElementById("inN").value;
    let h = Number(document.getElementById("inH").value);
    let s = Number(document.getElementById("inS").value);
    let sat = document.getElementById("inSat").value;
    let f = document.getElementById("inF").value;
    db.collection("barang").add({ nama:n, harga:h, stok:s, satuan:sat, foto:f });
    alert("Ok!");
}

function hapus(id) { if(confirm("Hapus?")) db.collection("barang").doc(id).delete(); }
function tutup() { document.getElementById("myModal").style.display = "none"; }
function pindah(v) {
    document.getElementById("viewB").className = v=='B' ? '' : 'hidden';
    document.getElementById("viewA").className = v=='A' ? '' : 'hidden';
}
</script>
</body>
</html>
