<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kios Bersama - Smart Catalog</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#f0f3f7; --card:#ffffff; --border:#e5e7eb;
  --text:#2e3137; --muted:#6d7588; --green:#00aa5b;
}
body{margin:0;font-family:system-ui, -apple-system, sans-serif;background:var(--bg);color:var(--text); scroll-behavior: smooth;}

header{
  background:var(--card); padding:12px 20px; display:flex; align-items:center; gap:20px;
  position:sticky; top:0; z-index:100; box-shadow:0 1px 6px rgba(0,0,0,0.1);
}
.logo{color:var(--green); font-weight:800; font-size:22px; cursor:pointer; white-space:nowrap}
.search-wrapper{flex:1; position:relative}
.search-wrapper input{
  width:100%; padding:10px 15px; border-radius:8px; border:1px solid var(--border);
  background:#f3f4f6; outline:none; box-sizing:border-box; transition: 0.3s;
}

.container{max-width:1150px; margin:20px auto; padding:0 20px; display:flex; gap:20px; flex-wrap:wrap}

.tabs{display:flex; gap:10px; margin-bottom:16px}
.tabs button{
  padding:8px 20px; border-radius:20px; border:1px solid var(--border);
  background:var(--card); cursor:pointer; font-weight:600; color:var(--muted); transition: 0.2s;
}
.tabs button.active{background:#e8faf1; color:var(--green); border-color:var(--green)}

.main-content{flex:3; min-width:300px}
.card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 1px 4px rgba(0,0,0,0.05)}

.grid-produk{display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:15px}
.item-produk{
  background:var(--card); border:1px solid var(--border); border-radius:10px; 
  overflow:hidden; transition:0.3s; display:flex; flex-direction:column; padding:12px; cursor: pointer;
}
.item-produk:hover{transform:translateY(-5px); box-shadow:0 8px 15px rgba(0,0,0,0.1)}
.img-box{width:100%; aspect-ratio:1/1; background:#f3f4f6; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:30px; overflow:hidden;}
.img-box img{width:100%; height:100%; object-fit:cover;}

.item-produk b{font-size:14px; height:38px; overflow:hidden; display:block; margin-bottom:4px; color:#333}
.item-produk .price{color:var(--green); font-weight:800; font-size:16px}
.item-produk .stok-tag{font-size:12px; color:var(--muted); margin-top:5px; background:#f8fafc; padding:2px 6px; border-radius:4px; width:fit-content}

.modal{
  position: fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(4px);
}
.modal-content{
  background:white; width:95%; max-width:850px; border-radius:20px; display:flex; position:relative; max-height: 90vh; overflow:hidden; animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from{transform:translateY(20px); opacity:0} to{transform:translateY(0); opacity:1} }

.close-modal{position:absolute; right:20px; top:15px; font-size:30px; cursor:pointer; color:var(--muted); z-index:11}
.modal-left{flex:1; background:#f9fafb; display:flex; align-items:center; justify-content:center; padding:40px}
.modal-right{flex:1.2; padding:30px; overflow-y: auto; display:flex; flex-direction:column}

.sidebar{flex:1; min-width:280px}
.cart-sticky{position:sticky; top:90px}

button{padding:12px; border:none; border-radius:10px; background:var(--green); color:white; cursor:pointer; font-weight:700; width:100%; transition: 0.2s}
button:active{transform: scale(0.98)}
button.danger{background:#ef4444}
button.gray{background:#64748b}
input,select,textarea{width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px; box-sizing:border-box}

.hidden{display:none}
@media (max-width: 750px) { .modal-content{flex-direction:column} .modal-left{padding:20px} .modal-left img{height:200px} }
</style>
</head>

<body>

<div id="productModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-modal" onclick="document.getElementById('productModal').style.display='none'">&times;</span>
    <div class="modal-left">
      <div id="modalImg" class="img-box" style="width:100%; height: 300px;">üì¶</div>
    </div>
    <div class="modal-right">
      <h1 id="modalTitle" style="margin:0; font-size: 26px;">Nama Produk</h1>
      <div id="modalPrice" style="font-size: 34px; font-weight:800; color:var(--green); margin:10px 0">Rp 0</div>
      <div id="modalStok" style="background:#fff0e6; color:#ff6600; padding:6px 12px; border-radius:8px; font-weight:700; width:fit-content">Sisa 0</div>
      
      <div style="border-top: 1px solid var(--border); margin-top: 20px; padding-top: 15px;">
        <span style="font-weight:800; color:var(--green)">Detail Produk</span>
        <div id="modalDesc" style="font-size:14px; margin-top:5px; line-height:1.6"></div>
      </div>
      
      <div id="generalNoteBox" style="margin-top:20px; padding:15px; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px; display:none">
        <b style="color:#475569; font-size:13px">üìù Catatan Toko:</b>
        <div id="generalNoteText" style="font-size:14px; margin-top:5px; color:#334155"></div>
      </div>
      
      <button id="modalAddBtn" style="margin-top:30px">+ Tambah ke Keranjang</button>
    </div>
  </div>
</div>

<header>
  <div class="logo" onclick="location.reload()">üß∫ Kios Bersama</div>
  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="Cari barang (Beras, Mie, Botol...)" onkeyup="filterBarang()">
  </div>
</header>

<div class="container">
  <div class="main-content">
    <div class="tabs">
      <button id="tabBuyer" class="active">üõí Belanja</button>
      <button id="tabAdmin">üîê Admin</button>
    </div>

    <div id="buyer">
      <div class="grid-produk" id="buyerList"></div>
    </div>

    <div id="admin" class="hidden">
      <div class="card">
        <h3>ü§ñ Asisten Stok</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:10px">
          <button class="gray" onclick="asisten('daftar')">üì¶ Daftar</button>
          <button class="danger" onclick="asisten('menipis')">‚ö†Ô∏è Menipis</button>
          <button style="background:#0ea5e9" onclick="asisten('total')">üìä Total</button>
        </div>
        <textarea id="aiInput" placeholder="Contoh: stok beras berapa?"></textarea>
        <button onclick="asisten('tanya')">Tanya Asisten</button>
        <div id="aiOutput" style="font-size:13px; margin-top:10px; padding:10px; background:#f9fafb; border-radius:8px; display:none; border-left:4px solid var(--green)"></div>
      </div>

      <div class="card">
        <h3>Tambah Barang Baru</h3>
        <input id="nama" placeholder="Nama Barang">
        <input id="harga" type="number" placeholder="Harga Jual (Tanpa titik)">
        <input id="stok" type="number" placeholder="Jumlah Stok">
        <select id="satuan">
          <option value="">Pilih Satuan</option>
          <option>Bungkus</option><option>Botol</option><option>Kg</option><option>Liter</option><option>Pcs</option><option>Kardus</option>
        </select>
        <input id="fotoUrl" placeholder="Link Foto (Opsional)">
        <textarea id="notes" placeholder="Catatan Toko"></textarea>
        <button onclick="simpan()">Simpan ke Database</button>
      </div>

      <div class="card">
        <h3>Data Inventaris</h3>
        <div id="adminList"></div>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="card cart-sticky">
      <h3>üõí Pesanan</h3>
      <div id="cart" style="font-size:13px; color:var(--muted); min-height:50px">Kosong</div>
      <div style="margin:15px 0; border-top:1px solid #eee; padding-top:10px">
        <b style="font-size: 18px">Total: Rp <span id="total">0</span></b>
      </div>
      <button onclick="checkout()">Pesan via WA</button>
    </div>
  </div>
</div>

<script>
const ADMIN_PW = "kios123";
const WA_NUMBER = "62811897005";
let adminUnlocked = false;
let BARANG = [];
let CART = {};

firebase.initializeApp({
  apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
  authDomain: "kios-30.firebaseapp.com",
  projectId: "kios-30"
});
const db = firebase.firestore();

// FUNGSI PEMBERSIH ANGKA (PENTING!)
function formatAngka(val) {
  if(!val) return 0;
  // Jika input adalah string dengan titik (misal "90.000"), hilangkan titiknya dulu
  let s = String(val).replace(/\./g, '');
  return Number(s) || 0;
}

/* REALTIME ENGINE */
db.collection("barang").onSnapshot(snap => {
  let list = [];
  snap.forEach(doc => {
    const d = doc.data();
    if (d.nama && d.nama.trim() !== "") {
      list.push({
        id: doc.id,
        nama: d.nama,
        // Gunakan pembersih harga di sini
        harga: formatAngka(d.harga),
        stok: formatAngka(d.stok),
        satuan: d.satuan || "pcs",
        foto: d.foto || "",
        notes: d.notes || ""
      });
    }
  });
  BARANG = list.sort((a,b) => a.nama.localeCompare(b.nama));
  renderBuyer();
  renderAdmin();
});

function renderBuyer(f = "") {
  const container = document.getElementById("buyerList");
  container.innerHTML = "";
  const filtered = BARANG.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));

  if (filtered.length === 0) {
    container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:gray">Barang tidak ditemukan...</div>`;
    return;
  }

  filtered.forEach(b => {
    container.innerHTML += `
      <div class="item-produk" onclick="openDetail('${b.id}')">
        <div class="img-box">${b.foto ? `<img src="${b.foto}" loading="lazy">` : 'üì¶'}</div>
        <b>${b.nama}</b>
        <div class="price">Rp ${b.harga.toLocaleString('id-ID')}</div>
        <div class="stok-tag">Stok: ${b.stok} ${b.satuan}</div>
      </div>`;
  });
}

function renderAdmin() {
  const container = document.getElementById("adminList");
  container.innerHTML = "";
  BARANG.forEach(b => {
    container.innerHTML += `
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:12px 0">
        <div>
          <b style="color:var(--green)">${b.nama}</b><br>
          <small>${b.stok} ${b.satuan} | Rp ${b.harga.toLocaleString('id-ID')}</small>
        </div>
        <button class="danger" style="width:auto; padding:5px 12px; font-size:12px" 
                onclick="if(confirm('Hapus ${b.nama}?')) db.collection('barang').doc('${b.id}').delete()">Hapus</button>
      </div>`;
  });
}

function openDetail(id) {
  const b = BARANG.find(x => x.id === id);
  if (!b) return;
  document.getElementById("modalTitle").innerText = b.nama;
  document.getElementById("modalPrice").innerText = "Rp " + b.harga.toLocaleString('id-ID');
  document.getElementById("modalStok").innerText = `Sisa: ${b.stok} ${b.satuan}`;
  document.getElementById("modalDesc").innerText = getSmartDesc(b.nama);
  document.getElementById("modalImg").innerHTML = b.foto ? `<img src="${b.foto}">` : "üì¶";
  
  const nb = document.getElementById("generalNoteBox");
  if (b.notes) {
    nb.style.display = "block";
    document.getElementById("generalNoteText").innerText = b.notes;
  } else { nb.style.display = "none"; }
  
  document.getElementById("modalAddBtn").onclick = () => { addCart(id); document.getElementById('productModal').style.display = 'none'; };
  document.getElementById("productModal").style.display = "flex";
}

function addCart(id) {
  const b = BARANG.find(x => x.id === id);
  if (!b) return;
  if ((CART[id] || 0) + 1 > b.stok) return alert("Stok tidak mencukupi!");
  CART[id] = (CART[id] || 0) + 1;
  renderCart();
}

function renderCart() {
  const c = document.getElementById("cart");
  c.innerHTML = "";
  let total = 0;
  for (let id in CART) {
    const b = BARANG.find(x => x.id === id);
    if (!b) continue;
    total += b.harga * CART[id];
    c.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px">
                      <span>${b.nama} (x${CART[id]})</span>
                      <span>Rp ${(b.harga * CART[id]).toLocaleString('id-ID')}</span>
                    </div>`;
  }
  document.getElementById("total").innerText = total.toLocaleString('id-ID');
}

function checkout() {
  if (Object.keys(CART).length === 0) return alert("Pilih barang dulu!");
  let msg = "*PESANAN KIOS BERSAMA*%0A---------------------------%0A";
  for (let id in CART) {
    const b = BARANG.find(x => x.id === id);
    msg += `‚Ä¢ ${b.nama} (x${CART[id]})%0A`;
  }
  msg += `---------------------------%0A*Total: Rp ${document.getElementById("total").innerText}*`;
  window.open(`https://wa.me/${WA_NUMBER}?text=${msg}`);
}

function simpan() {
  const n = document.getElementById("nama"), h = document.getElementById("harga"),
        s = document.getElementById("stok"), sat = document.getElementById("satuan"),
        nt = document.getElementById("notes"), f = document.getElementById("fotoUrl");
  
  if (!n.value || !h.value || !s.value) return alert("Lengkapi data!");
  
  db.collection("barang").add({
    nama: n.value.trim(), 
    harga: Number(h.value), // Input type number sudah otomatis bersih
    stok: Number(s.value), 
    satuan: sat.value || "pcs", 
    notes: nt.value, 
    foto: f.value
  }).then(() => {
    n.value = h.value = s.value = nt.value = f.value = "";
    alert("Berhasil!");
  });
}

function asisten(mode) {
  const out = document.getElementById("aiOutput");
  out.style.display = "block";
  if (mode === 'daftar') out.innerHTML = BARANG.map(b => `‚Ä¢ ${b.nama} (${b.stok})`).join("<br>");
  if (mode === 'menipis') {
    const low = BARANG.filter(b => b.stok <= 5);
    out.innerHTML = low.length ? low.map(b => `‚ö†Ô∏è ${b.nama} sisa ${b.stok}`).join("<br>") : "‚úÖ Stok aman semua";
  }
  if (mode === 'total') out.innerText = `Total Jenis: ${BARANG.length}`;
  if (mode === 'tanya') {
    const q = document.getElementById("aiInput").value.toLowerCase();
    const b = BARANG.find(x => q.includes(x.nama.toLowerCase()));
    out.innerText = b ? `ü§ñ ${b.nama} ada ${b.stok} ${b.satuan}.` : "ü§ñ Barang tidak ada.";
  }
}

function getSmartDesc(n) {
  n = n.toLowerCase();
  if (n.includes("mie")) return "Mie instan pilihan, cocok untuk stok di rumah.";
  if (n.includes("beras")) return "Beras pulen kualitas terbaik, bersih dan sehat.";
  return "Produk berkualitas untuk memenuhi kebutuhan harian Anda.";
}

function filterBarang() { renderBuyer(document.getElementById("searchInput").value); }
function closeModal(e) { if (e.target.id === "productModal") e.target.style.display = "none"; }

tabBuyer.onclick = () => {
  document.getElementById("buyer").classList.remove("hidden");
  document.getElementById("admin").classList.add("hidden");
  tabBuyer.classList.add("active"); tabAdmin.classList.remove("active");
};
tabAdmin.onclick = () => {
  if (!adminUnlocked) {
    if (prompt("Password Admin:") !== ADMIN_PW) return;
    adminUnlocked = true;
  }
  document.getElementById("admin").classList.remove("hidden");
  document.getElementById("buyer").classList.add("hidden");
  tabAdmin.classList.add("active"); tabBuyer.classList.remove("active");
};
</script>
</body>
</html>
