<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kios Bersama</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f172a;--card:#111827;--border:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;--green:#22c55e;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{background:var(--green);padding:16px;text-align:center;font-weight:700}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
button{padding:10px;border:none;border-radius:10px;background:var(--green);cursor:pointer;font-weight:600}
button.danger{background:#ef4444;color:white}
button.gray{background:#334155;color:white}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#020617;color:var(--text)}
.item{border-bottom:1px solid var(--border);padding:10px 0}
.flex{display:flex;justify-content:space-between;gap:10px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}
.tabs{display:flex;margin-bottom:16px}
.tabs button{flex:1;background:#1f2937;color:white}
.tabs button.active{background:var(--green);color:#022c22}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
</style>
</head>

<body>
<header>üß∫ Kios Bersama</header>

<div class="container">

<div class="tabs">
  <button id="tabBuyer" class="active">üõí Pembeli</button>
  <button id="tabAdmin">üîê Admin</button>
</div>

<!-- ================= BUYER ================= -->
<div id="buyer">
  <div class="card">
    <h3>Daftar Barang</h3>
    <div id="buyerList"></div>
  </div>

  <div class="card">
    <h3>Keranjang</h3>
    <div id="cart" class="small"></div>
    <b>Total: Rp <span id="total">0</span></b>

    <div class="grid" style="margin-top:10px">
      <button onclick="checkout()">Checkout WA</button>
      <button class="gray" onclick="resetCart()">Reset Keranjang</button>
    </div>
  </div>
</div>

<!-- ================= ADMIN ================= -->
<div id="admin" class="hidden">

  <div class="card">
    <h3>ü§ñ Asisten Stok</h3>
    <div class="grid">
      <button onclick="asisten('daftar')">üì¶ Daftar</button>
      <button onclick="asisten('menipis')">‚ö†Ô∏è Menipis</button>
      <button onclick="asisten('total')">üìä Total</button>
    </div>
    <textarea id="aiInput" placeholder="contoh: stok gula berapa?"></textarea>
    <button style="margin-top:8px" onclick="asisten('tanya')">Tanya</button>
    <div id="aiOutput" class="small" style="margin-top:8px;display:none"></div>
  </div>

  <div class="card">
    <h3>Tambah Barang</h3>
    <div class="grid">
      <input id="nama" placeholder="Nama">
      <input id="harga" type="number" placeholder="Harga">
      <input id="stok" type="number" placeholder="Stok">
      <select id="satuan">
        <option value="">Satuan</option>
        <option>Kilogram</option>
        <option>Ons</option>
        <option>Gram</option>
        <option>Liter</option>
        <option>Mililiter</option>
        <option>Botol</option>
        <option>Sachet</option>
        <option>Bungkus</option>
        <option>Pack</option>
        <option>Kardus</option>
        <option>Renceng</option>
        <option>Rak</option>
        <option>Karung</option>
        <option>Butir</option>
        <option>Potong</option>
      </select>
    </div>
    <button style="margin-top:10px" onclick="simpan()">Simpan</button>
  </div>

  <div class="card">
    <h3>Data Barang</h3>
    <div id="adminList"></div>
  </div>

</div>
</div>

<script>
/* ===== CONFIG ===== */
const ADMIN_PW = "kios123";
let adminUnlocked = false;

firebase.initializeApp({
  apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
  authDomain: "kios-30.firebaseapp.com",
  projectId: "kios-30"
});
const db = firebase.firestore();

let BARANG = [];
let CART = {};
const WA = "62811897005";

/* ===== DOM ===== */
const buyer = document.getElementById("buyer");
const admin = document.getElementById("admin");
const buyerList = document.getElementById("buyerList");
const adminList = document.getElementById("adminList");
const cart = document.getElementById("cart");
const totalEl = document.getElementById("total");

const nama = document.getElementById("nama");
const harga = document.getElementById("harga");
const stok = document.getElementById("stok");
const satuan = document.getElementById("satuan");

const aiInput = document.getElementById("aiInput");
const aiOutput = document.getElementById("aiOutput");

/* ===== FIRESTORE SAFE ===== */
db.collection("barang").onSnapshot(snap=>{
  BARANG=[];
  snap.forEach(doc=>{
    const d=doc.data();
    if(!d?.nama||d.harga==null||d.stok==null||!d.satuan) return;
    BARANG.push({id:doc.id,...d});
  });
  renderBuyer();
  renderAdmin();
});

/* ===== CRUD ===== */
function simpan(){
  if(!nama.value||!harga.value||!stok.value||!satuan.value)
    return alert("Lengkapi data");
  db.collection("barang").add({
    nama:nama.value,
    harga:+harga.value,
    stok:+stok.value,
    satuan:satuan.value
  });
  nama.value=harga.value=stok.value="";
}

/* ===== RENDER ===== */
function renderBuyer(){
  buyerList.innerHTML="";
  BARANG.forEach(b=>{
    buyerList.innerHTML+=`
      <div class="item flex">
        <div>
          <b>${b.nama}</b>
          <div class="small">Rp ${b.harga} / ${b.satuan} ‚Ä¢ Stok ${b.stok}</div>
        </div>
        <button onclick="addCart('${b.id}')">+</button>
      </div>`;
  });
}

function renderAdmin(){
  adminList.innerHTML="";
  BARANG.forEach(b=>{
    adminList.innerHTML+=`
      <div class="item flex">
        <b>${b.nama}</b>
        <button class="danger" onclick="hapus('${b.id}')">Hapus</button>
      </div>`;
  });
}

function hapus(id){
  if(confirm("Hapus barang?"))
    db.collection("barang").doc(id).delete();
}

/* ===== CART ===== */
function addCart(id){
  CART[id]=(CART[id]||0)+1;
  renderCart();
}

function resetCart(){
  if(!confirm("Reset seluruh keranjang?")) return;
  CART={};
  renderCart();
}

function renderCart(){
  cart.innerHTML="";
  let total=0;
  for(let id in CART){
    const b=BARANG.find(x=>x.id===id);
    if(!b) continue;
    total+=b.harga*CART[id];
    cart.innerHTML+=`${b.nama} x ${CART[id]}<br>`;
  }
  totalEl.innerText=total.toLocaleString();
}

/* ===== CHECKOUT ===== */
function checkout(){
  if(Object.keys(CART).length===0)
    return alert("Keranjang masih kosong");
  let msg="Halo, saya mau pesan:%0A";
  let total=0;
  for(let id in CART){
    const b=BARANG.find(x=>x.id===id);
    if(!b) continue;
    msg+=`‚Ä¢ ${b.nama} x ${CART[id]}%0A`;
    total+=b.harga*CART[id];
  }
  msg+=`Total: Rp ${total}`;
  window.open(`https://wa.me/${WA}?text=${msg}`);
}

/* ===== ASISTEN ===== */
function asisten(mode){
  aiOutput.style.display="block";
  if(BARANG.length===0){
    aiOutput.innerText="ü§ñ Data kosong";
    return;
  }
  if(mode==="daftar"){
    aiOutput.innerHTML=BARANG.map(b=>`‚Ä¢ ${b.nama} (${b.stok} ${b.satuan})`).join("<br>");
    return;
  }
  if(mode==="menipis"){
    const low=BARANG.filter(b=>b.stok<=5);
    aiOutput.innerHTML=low.length
      ? low.map(b=>`‚ö†Ô∏è ${b.nama}: ${b.stok}`).join("<br>")
      : "‚úÖ Semua stok aman";
    return;
  }
  if(mode==="total"){
    aiOutput.innerText=`üìä Total jenis barang: ${BARANG.length}`;
    return;
  }
  if(mode==="tanya"){
    const q=aiInput.value.toLowerCase();
    const b=BARANG.find(x=>q.includes(x.nama.toLowerCase()));
    aiOutput.innerText=b
      ? `ü§ñ Stok ${b.nama}: ${b.stok} ${b.satuan}`
      : "ü§ñ Barang tidak ditemukan";
  }
}

/* ===== TABS ===== */
tabBuyer.onclick=()=>{
  buyer.classList.remove("hidden");
  admin.classList.add("hidden");
  tabBuyer.classList.add("active");
  tabAdmin.classList.remove("active");
};

tabAdmin.onclick=()=>{
  if(!adminUnlocked){
    const pw=prompt("Password admin:");
    if(pw!==ADMIN_PW) return alert("Password salah");
    adminUnlocked=true;
  }
  admin.classList.remove("hidden");
  buyer.classList.add("hidden");
  tabAdmin.classList.add("active");
  tabBuyer.classList.remove("active");
};
</script>
</body>
</html>
