<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kios Bersama - Smart Catalog</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#f0f3f7; --card:#ffffff; --border:#e5e7eb;
  --text:#2e3137; --muted:#6d7588; --green:#00aa5b;
}
body{margin:0;font-family:system-ui, -apple-system, sans-serif;background:var(--bg);color:var(--text); scroll-behavior: smooth;}

header{
  background:var(--card); padding:12px 20px; display:flex; align-items:center; gap:20px;
  position:sticky; top:0; z-index:100; box-shadow:0 1px 6px rgba(0,0,0,0.1);
}
.logo{color:var(--green); font-weight:800; font-size:22px; cursor:pointer; white-space:nowrap}
.search-wrapper{flex:1; position:relative}
.search-wrapper input{
  width:100%; padding:10px 15px; border-radius:8px; border:1px solid var(--border);
  background:#f3f4f6; outline:none; box-sizing:border-box; transition: 0.3s;
}

.banner-slider{
  width: 100%; max-width: 1100px; margin: 15px auto; height: 180px;
  border-radius: 12px; overflow: hidden; position: relative; background: #ddd;
}
.slide-track{display: flex; width: 300%; height: 100%; transition: 0.5s;}
.slide-img{
  width: 100%; height: 100%; background-size: cover; background-position: center;
  display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.cat-container{
  max-width: 1100px; margin: 10px auto; display: flex; gap: 10px; overflow-x: auto; padding: 5px 20px;
}
.cat-pill{
  padding: 8px 18px; background: white; border: 1px solid var(--border); border-radius: 20px;
  white-space: nowrap; cursor: pointer; font-size: 14px; font-weight: 600;
}
.cat-pill.active{ background: var(--green); color: white; border-color: var(--green); }

.container{max-width:1150px; margin:20px auto; padding:0 20px; display:flex; gap:20px; flex-wrap:wrap}

.tabs{display:flex; gap:10px; margin-bottom:16px}
.tabs button{
  padding:12px 20px; border-radius:20px; border:1px solid var(--border);
  background:var(--card); cursor:pointer; font-weight:600; color:var(--muted); transition: 0.2s;
}
.tabs button.active{background:#e8faf1; color:var(--green); border-color:var(--green)}

.main-content{flex:3; min-width:300px}
.card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 1px 4px rgba(0,0,0,0.05)}

.grid-produk{display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:15px}
.item-produk{
  background:var(--card); border:1px solid var(--border); border-radius:10px; 
  overflow:hidden; transition:0.3s; display:flex; flex-direction:column; padding:12px; cursor: pointer;
}
.item-produk:hover{transform:translateY(-5px); box-shadow:0 8px 15px rgba(0,0,0,0.1)}
.img-box{width:100%; aspect-ratio:1/1; background:#f3f4f6; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:30px; overflow:hidden;}
.img-box img{width:100%; height:100%; object-fit:cover;}

.item-produk b{font-size:14px; height:38px; overflow:hidden; display:block; margin-bottom:4px; color:#333}
.item-produk .price{color:var(--green); font-weight:800; font-size:16px}
.item-produk .stok-tag{font-size:12px; color:var(--muted); margin-top:5px; background:#f8fafc; padding:2px 6px; border-radius:4px; width:fit-content}

.qty-control{
  display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); 
  width: fit-content; padding: 5px 10px; border-radius: 10px; margin: 15px 0;
}
.qty-btn{ background: none; color: var(--green); font-size: 20px; width: 30px; padding: 0; cursor: pointer;}
.qty-input{ width: 75px; text-align: center; border: 1px solid #eee; margin: 0; font-weight: bold; background: white; border-radius: 5px; padding: 5px 0;}

.modal{
  position: fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(4px);
}
.modal-content{
  background:white; width:95%; max-width:850px; border-radius:20px; display:flex; position:relative; max-height: 90vh; overflow:hidden; animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from{transform:translateY(20px); opacity:0} to{transform:translateY(0); opacity:1} }

.close-modal{position:absolute; right:20px; top:15px; font-size:30px; cursor:pointer; color:var(--muted); z-index:11}
.modal-left{flex:1; background:#f9fafb; display:flex; align-items:center; justify-content:center; padding:40px}
.modal-right{flex:1.2; padding:30px; overflow-y: auto; display:flex; flex-direction:column}

.sidebar{flex:1; min-width:280px}
.cart-sticky{position:sticky; top:90px}

button{padding:12px; border:none; border-radius:10px; background:var(--green); color:white; cursor:pointer; font-weight:700; width:100%; transition: 0.2s}
button:active{transform: scale(0.98)}
button.danger{background:#ef4444}
input,select,textarea{width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px; box-sizing:border-box}

.hidden{display:none}
@media (max-width: 750px) { .modal-content{flex-direction:column} .modal-left{padding:20px} .modal-left img{height:200px} }
</style>
</head>

<body>

<div id="productModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-modal" onclick="document.getElementById('productModal').style.display='none'">&times;</span>
    <div class="modal-left">
      <div id="modalImg" class="img-box" style="width:100%; height: 300px;">üì¶</div>
    </div>
    <div class="modal-right">
      <h1 id="modalTitle" style="margin:0; font-size: 26px;">Nama Produk</h1>
      <div id="modalPrice" style="font-size: 34px; font-weight:800; color:var(--green); margin:10px 0">Rp 0</div>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border)">
        <span style="font-size: 13px; font-weight: bold; color: var(--muted)">Atur jumlah (Bisa ketik desimal misal 0.5)</span>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px;">
           <div class="qty-control">
             <button class="qty-btn" onclick="updateQty(-0.5)">-</button>
             <input id="modalQty" class="qty-input" type="number" step="0.01" value="1" oninput="updateSubtotal()">
             <button class="qty-btn" onclick="updateQty(0.5)">+</button>
           </div>
           <div style="text-align: right">
             <small style="color: var(--muted)">Subtotal</small><br>
             <b id="modalSubtotal" style="font-size: 18px; color: #333">Rp 0</b>
           </div>
        </div>
        <div id="modalStokInfo" style="font-size: 12px; color: var(--muted); margin-top: 5px;">Sisa Stok: 0</div>
      </div>

      <div style="border-top: 1px solid var(--border); margin-top: 20px; padding-top: 15px;">
        <span style="font-weight:800; color:var(--green)">Catatan/Deskripsi Produk</span>
        <div id="modalDesc" style="font-size:14px; margin-top:5px; line-height:1.6; color:#555">Tidak ada catatan tambahan.</div>
      </div>
      
      <button id="modalAddBtn" style="margin-top:30px; font-size: 16px;">+ Tambah ke Keranjang</button>
    </div>
  </div>
</div>

<header>
  <div class="logo" onclick="location.reload()">üß∫ Kios Bersama</div>
  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="Cari barang yang ingin dibeli..." onkeyup="filterBarang()">
  </div>
</header>

<div class="banner-slider">
  <div class="slide-track" id="slider">
    <div class="slide-img" id="banner0">Promo 1</div>
    <div class="slide-img" id="banner1">Promo 2</div>
    <div class="slide-img" id="banner2">Promo 3</div>
  </div>
</div>

<div class="cat-container" id="categoryBar">
  <div class="cat-pill active" onclick="setCategory('Semua')">Semua</div>
</div>

<div class="container">
  <div class="main-content">
    <div class="tabs">
      <button id="tabBuyer" class="active">üõí Belanja</button>
      <button id="tabSaran">üí° Saran</button>
      <button id="tabAdmin">üîê Admin</button>
    </div>

    <div id="viewBuyer">
      <div class="grid-produk" id="buyerList"></div>
    </div>

    <div id="viewSaran" class="hidden">
      <div class="card">
        <h3>üí° Kritik & Saran Pembeli</h3>
        <p style="font-size: 14px; color: var(--muted); margin-bottom: 20px;">Kami sangat menghargai setiap masukan Anda agar layanan kami semakin baik.</p>
        <label style="font-weight: bold; font-size: 13px;">Nama Lengkap</label>
        <input id="saranNama" placeholder="Masukkan nama Anda">
        <label style="font-weight: bold; font-size: 13px;">Pesan Saran/Kritik</label>
        <textarea id="saranPesan" placeholder="Apa yang ingin Anda sampaikan?" style="height: 150px;"></textarea>
        <button onclick="kirimSaran()" style="background: #2e3137;">Kirim Masukan Anda</button>
      </div>
    </div>

    <div id="viewAdmin" class="hidden">
      <div class="card">
        <h3>üñºÔ∏è Pengaturan Banner Iklan</h3>
        <p style="font-size: 12px; color: var(--muted);">Tempelkan URL gambar untuk mengganti slide banner di halaman utama.</p>
        <input id="b0" placeholder="URL Gambar Slide 1">
        <input id="b1" placeholder="URL Gambar Slide 2">
        <input id="b2" placeholder="URL Gambar Slide 3">
        <button onclick="saveBanners()">Simpan Banner</button>
      </div>
      
      <div class="card">
        <h3>üí¨ Kotak Pesan Masuk</h3>
        <div id="adminSaranList" style="max-height: 250px; overflow-y: auto; background: #f9fafb; padding: 10px; border-radius: 8px;"></div>
      </div>

      <div class="card">
        <h3>Tambah Barang Baru</h3>
        <input id="nama" placeholder="Nama Barang">
        <input id="harga" type="text" placeholder="Harga Jual (Gunakan titik untuk ribuan)">
        <input id="stok" type="number" step="0.01" placeholder="Jumlah Stok Awal">
        <div style="display: flex; gap: 5px;">
            <select id="satuan" style="flex:1">
              <option>Kg</option><option>Bungkus</option><option>Botol</option><option>Liter</option><option>Pcs</option>
            </select>
            <input id="kategori" placeholder="Kategori Barang" style="flex:1">
        </div>
        <input id="fotoUrl" placeholder="Link/URL Foto Barang">
        <textarea id="notes" placeholder="Catatan tambahan barang..."></textarea>
        <button onclick="simpan()">Simpan ke Inventaris</button>
      </div>
      
      <div class="card">
        <h3>üì¶ Daftar Inventaris Barang</h3>
        <div id="adminList"></div>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="card cart-sticky">
      <h3>üõí Daftar Pesanan</h3>
      <div id="cart" style="font-size:13px; color:var(--muted); min-height:80px; line-height: 1.6;">Kosong</div>
      <div style="margin:15px 0; border-top:2px solid #f0f3f7; padding-top:15px">
        <b style="font-size: 18px">Total Pembayaran:</b><br>
        <b style="font-size: 24px; color: var(--green);">Rp <span id="total">0</span></b>
      </div>
      <button onclick="checkout()" style="height: 55px; font-size: 16px;">Pesan Lewat WhatsApp</button>
    </div>
  </div>
</div>

<script>
// KONFIGURASI UTAMA
const ADMIN_PW = "kios123";
const WA_NUMBER = "62811897005";
let adminUnlocked = false;
let BARANG = [];
let CART = {};
let currentModalItem = null;
let currentCat = "Semua";

// INISIALISASI FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
  authDomain: "kios-30.firebaseapp.com",
  projectId: "kios-30"
});
const db = firebase.firestore();

// CLEANER ANGKA
function cleanNum(v) {
  if (!v) return 0;
  return parseFloat(String(v).replace(/\./g, '').replace(/,/g, '')) || 0;
}

// LOGIKA BANNER
db.collection("settings").doc("banners").onSnapshot(doc => {
    if(doc.exists()) {
        const urls = doc.data().urls;
        urls.forEach((u, i) => {
            if(u) {
                const el = document.getElementById(`banner${i}`);
                el.style.backgroundImage = `url('${u}')`;
                el.innerText = "";
                document.getElementById(`b${i}`).value = u;
            }
        });
    }
});

function saveBanners() {
    const u0 = document.getElementById('b0').value;
    const u1 = document.getElementById('b1').value;
    const u2 = document.getElementById('b2').value;
    db.collection("settings").doc("banners").set({urls: [u0, u1, u2]}).then(() => alert("Banner Berhasil Diupdate!"));
}

// DATA LISTENER BARANG
db.collection("barang").onSnapshot(snap => {
  let list = [];
  let uniqueCats = new Set(["Semua"]);
  snap.forEach(doc => {
    const d = doc.data();
    list.push({ id: doc.id, ...d, harga: cleanNum(d.harga), stok: parseFloat(d.stok) || 0 });
    if(d.kategori) uniqueCats.add(d.kategori);
  });
  // URUTKAN AGAR TIDAK BENTROK (HIDUP BERTIGA)
  BARANG = list.sort((a,b) => a.nama.localeCompare(b.nama) || a.harga - b.harga);
  renderCategories(Array.from(uniqueCats));
  renderBuyer();
  renderAdmin();
});

// LOGIKA MODAL & KERANJANG
function openDetail(id) {
  const b = BARANG.find(x => x.id === id);
  if (!b) return;
  currentModalItem = b;
  document.getElementById("modalTitle").innerText = b.nama;
  document.getElementById("modalPrice").innerText = "Rp " + b.harga.toLocaleString('id-ID');
  document.getElementById("modalStokInfo").innerText = `Sisa Stok di Kios: ${b.stok} ${b.satuan}`;
  document.getElementById("modalDesc").innerText = b.notes || "Tidak ada catatan tambahan.";
  document.getElementById("modalImg").innerHTML = b.foto ? `<img src="${b.foto}">` : "üì¶";
  document.getElementById("modalQty").value = 1;
  updateSubtotal();
  
  document.getElementById("modalAddBtn").onclick = function() {
      const q = parseFloat(document.getElementById("modalQty").value);
      if(isNaN(q) || q <= 0) return alert("Masukkan jumlah yang benar!");
      if(q > b.stok) return alert("Maaf, stok tidak mencukupi permintaan Anda.");
      
      CART[id] = (CART[id] || 0) + q;
      renderCart();
      document.getElementById('productModal').style.display = 'none';
  };
  
  document.getElementById("productModal").style.display = "flex";
}

function updateQty(delta) {
  const i = document.getElementById("modalQty");
  let v = (parseFloat(i.value) || 0) + delta;
  if (v < 0.01) v = 0.01;
  if (v > currentModalItem.stok) v = currentModalItem.stok;
  i.value = v.toFixed(2);
  updateSubtotal();
}

function updateSubtotal() {
  const q = parseFloat(document.getElementById("modalQty").value) || 0;
  const p = currentModalItem ? currentModalItem.harga : 0;
  document.getElementById("modalSubtotal").innerText = "Rp " + (q * p).toLocaleString('id-ID');
}

function renderCart() {
  const c = document.getElementById("cart");
  c.innerHTML = ""; let t = 0;
  for (let id in CART) {
    const b = BARANG.find(x => x.id === id);
    if (!b) continue;
    let s = b.harga * CART[id]; t += s;
    c.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #f9fafb; padding-bottom:5px">
      <div style="flex:1"><b>${b.nama}</b><br><small>${CART[id]} ${b.satuan}</small></div>
      <div style="font-weight:bold; color:#333">Rp ${s.toLocaleString('id-ID')}</div>
    </div>`;
  }
  document.getElementById("total").innerText = t.toLocaleString('id-ID');
  if(t === 0) c.innerHTML = "Belum ada barang dipilih.";
}

// LOGIKA KRITIK & SARAN
function kirimSaran() {
    const n = document.getElementById('saranNama').value;
    const p = document.getElementById('saranPesan').value;
    if(!n || !p) return alert("Mohon lengkapi Nama dan Isi Pesan.");
    db.collection("saran").add({ nama: n, pesan: p, tgl: new Date().toLocaleString() })
    .then(() => { 
        alert("Saran Anda telah kami terima. Terima kasih!"); 
        document.getElementById('saranNama').value=""; 
        document.getElementById('saranPesan').value=""; 
        showView("Buyer");
    });
}

db.collection("saran").orderBy("tgl", "desc").onSnapshot(snap => {
    const list = document.getElementById('adminSaranList');
    list.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += `<div style="background:white; padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid #eee">
            <b style="color:var(--green)">${d.nama}</b> <small style="color:#aaa">(${d.tgl})</small><br>
            <div style="margin-top:5px; font-style: italic;">"${d.pesan}"</div>
        </div>`;
    });
});

// LOGIKA VIEW BUYER & ADMIN
function renderBuyer(f = "") {
  const container = document.getElementById("buyerList");
  container.innerHTML = "";
  let filtered = BARANG.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));
  if(currentCat !== "Semua") filtered = filtered.filter(b => b.kategori === currentCat);
  filtered.forEach(b => {
    container.innerHTML += `<div class="item-produk" onclick="openDetail('${b.id}')">
        <div class="img-box">${b.foto ? `<img src="${b.foto}">` : 'üì¶'}</div>
        <b>${b.nama}</b><div class="price">Rp ${b.harga.toLocaleString('id-ID')}</div>
        <div class="stok-tag">Stok: ${b.stok} ${b.satuan}</div>
    </div>`;
  });
}

function renderAdmin() {
  const container = document.getElementById("adminList");
  container.innerHTML = "";
  BARANG.forEach(b => {
    container.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px 0; align-items:center">
      <div><b>${b.nama}</b><br><small>Rp ${b.harga.toLocaleString()} | Stok: ${b.stok} | Catatan: ${b.notes || '-'}</small></div>
      <button class="danger" style="width:auto; padding:5px 15px" onclick="if(confirm('Hapus barang ini?')) db.collection('barang').doc('${b.id}').delete()">Hapus</button>
    </div>`;
  });
}

// CHECKOUT WA
function checkout() {
  if (Object.keys(CART).length === 0) return alert("Keranjang belanja masih kosong!");
  const h = new Date().getHours();
  let s = h < 11 ? "Pagi" : h < 15 ? "Siang" : h < 19 ? "Sore" : "Malam";
  let m = `Halo Selamat ${s}, saya mau pesan beberapa barang berikut:%0A---------------------------%0A`;
  for (let id in CART) {
    const b = BARANG.find(x => x.id === id);
    m += `‚Ä¢ *${b.nama}* (${CART[id]} ${b.satuan})%0A`;
  }
  m += `---------------------------%0A*Total: Rp ${document.getElementById("total").innerText}*%0A%0A_Saya ingin bertanya, apakah harganya masih bisa nego?_`;
  window.open(`https://wa.me/${WA_NUMBER}?text=${m}`);
}

// SIMPAN BARANG ADMIN
function simpan() {
  const n = document.getElementById("nama"), h = document.getElementById("harga"),
        s = document.getElementById("stok"), sat = document.getElementById("satuan"),
        k = document.getElementById("kategori"), f = document.getElementById("fotoUrl"),
        nt = document.getElementById("notes");
  if(!n.value || !h.value) return alert("Nama dan Harga wajib diisi.");
  db.collection("barang").add({
    nama: n.value, harga: cleanNum(h.value), stok: parseFloat(s.value) || 0,
    satuan: sat.value, kategori: k.value, foto: f.value, notes: nt.value
  }).then(() => { 
      n.value=h.value=s.value=f.value=nt.value=""; 
      alert("Barang berhasil ditambahkan!"); 
  });
}

// NAVIGASI TAB
function showView(v) {
    ["viewBuyer", "viewSaran", "viewAdmin"].forEach(id => document.getElementById(id).classList.add("hidden"));
    ["tabBuyer", "tabSaran", "tabAdmin"].forEach(id => document.getElementById(id).classList.remove("active"));
    document.getElementById("view" + v).classList.remove("hidden");
    document.getElementById("tab" + v).classList.add("active");
}

tabBuyer.onclick = () => showView("Buyer");
tabSaran.onclick = () => showView("Saran");
tabAdmin.onclick = () => {
    if (!adminUnlocked) {
        if (prompt("Masukkan Password Keamanan Admin:") !== ADMIN_PW) return;
        adminUnlocked = true;
    }
    showView("Admin");
};

// FITUR TAMBAHAN HEADER & CATEGORY
function renderCategories(cats) {
    document.getElementById('categoryBar').innerHTML = cats.map(c => `<div class="cat-pill ${currentCat === c ? 'active' : ''}" onclick="setCategory('${c}')">${c}</div>`).join('');
}
function setCategory(cat) { currentCat = cat; renderBuyer(); }
function filterBarang() { renderBuyer(document.getElementById("searchInput").value); }
function closeModal(e) { if (e.target.id === "productModal") e.target.style.display = "none"; }

// SLIDER ANIMASI
let slidePos = 0;
setInterval(() => {
    slidePos = (slidePos + 1) % 3;
    const s = document.getElementById('slider');
    if(s) s.style.transform = `translateX(-${slidePos * 33.33}%)`;
}, 5000);
</script>
</body>
</html>
