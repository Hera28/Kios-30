<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kios Bersama - Smart Catalog</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#f0f3f7; --card:#ffffff; --border:#e5e7eb;
  --text:#2e3137; --muted:#6d7588; --green:#00aa5b;
}
body{margin:0;font-family:system-ui, -apple-system, sans-serif;background:var(--bg);color:var(--text); scroll-behavior: smooth;}

header{
  background:var(--card); padding:12px 20px; display:flex; align-items:center; gap:20px;
  position:sticky; top:0; z-index:100; box-shadow:0 1px 6px rgba(0,0,0,0.1);
}
.logo{color:var(--green); font-weight:800; font-size:22px; cursor:pointer; white-space:nowrap}
.search-wrapper{flex:1; position:relative}
.search-wrapper input{
  width:100%; padding:10px 15px; border-radius:8px; border:1px solid var(--border);
  background:#f3f4f6; outline:none; box-sizing:border-box; transition: 0.3s;
}

.banner-slider{
  width: 100%; max-width: 1100px; margin: 15px auto; height: 180px;
  border-radius: 12px; overflow: hidden; position: relative; background: #ddd;
}
.slide-track{display: flex; width: 300%; height: 100%; transition: 0.5s;}
.slide-img{
  width: 100%; height: 100%; background-size: cover; background-position: center;
  display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.cat-container{
  max-width: 1100px; margin: 10px auto; display: flex; gap: 10px; overflow-x: auto; padding: 5px 20px;
}
.cat-pill{
  padding: 8px 18px; background: white; border: 1px solid var(--border); border-radius: 20px;
  white-space: nowrap; cursor: pointer; font-size: 14px; font-weight: 600;
}
.cat-pill.active{ background: var(--green); color: white; border-color: var(--green); }

.container{max-width:1150px; margin:20px auto; padding:0 20px; display:flex; gap:20px; flex-wrap:wrap}

.tabs{display:flex; gap:10px; margin-bottom:16px}
.tabs button{
  padding:12px 20px; border-radius:20px; border:1px solid var(--border);
  background:var(--card); cursor:pointer; font-weight:600; color:var(--muted); transition: 0.2s;
}
.tabs button.active{background:#e8faf1; color:var(--green); border-color:var(--green)}

.main-content{flex:3; min-width:300px}
.card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 1px 4px rgba(0,0,0,0.05)}

.grid-produk{display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:15px}
.item-produk{
  background:var(--card); border:1px solid var(--border); border-radius:10px; 
  overflow:hidden; transition:0.3s; display:flex; flex-direction:column; padding:12px; cursor: pointer;
}
.item-produk:hover{transform:translateY(-5px); box-shadow:0 8px 15px rgba(0,0,0,0.1)}
.img-box{width:100%; aspect-ratio:1/1; background:#f3f4f6; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:30px; overflow:hidden;}
.img-box img{width:100%; height:100%; object-fit:cover;}

/* STYLE KHUSUS DAFTAR INVENTARIS ADMIN */
.admin-item-row {
  display: flex; align-items: center; gap: 15px; padding: 12px;
  border-bottom: 1px solid #f0f0f0; transition: 0.2s;
}
.admin-item-row:hover { background: #f9f9f9; }
.admin-img-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; background: #eee; }
.admin-info { flex: 1; }
.admin-info b { display: block; font-size: 14px; }
.admin-info span { font-size: 12px; color: var(--muted); }

.qty-control{
  display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); 
  width: fit-content; padding: 5px 10px; border-radius: 10px; margin: 15px 0;
}
.qty-btn{ background: none; color: var(--green); font-size: 20px; width: 30px; padding: 0; cursor: pointer;}
.qty-input{ width: 75px; text-align: center; border: 1px solid #eee; margin: 0; font-weight: bold; background: white; border-radius: 5px; padding: 5px 0;}

.modal{
  position: fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(4px);
}
.modal-content{
  background:white; width:95%; max-width:850px; border-radius:20px; display:flex; position:relative; max-height: 90vh; overflow:hidden; animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from{transform:translateY(20px); opacity:0} to{transform:translateY(0); opacity:1} }

.close-modal{position:absolute; right:20px; top:15px; font-size:30px; cursor:pointer; color:var(--muted); z-index:11}
.modal-left{flex:1; background:#f9fafb; display:flex; align-items:center; justify-content:center; padding:40px}
.modal-right{flex:1.2; padding:30px; overflow-y: auto; display:flex; flex-direction:column}

.sidebar{flex:1; min-width:280px}
.cart-sticky{position:sticky; top:90px}

button{padding:12px; border:none; border-radius:10px; background:var(--green); color:white; cursor:pointer; font-weight:700; width:100%; transition: 0.2s}
button:active{transform: scale(0.98)}
button.danger{background:#ef4444}
input,select,textarea{width:100%; padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px; box-sizing:border-box}

.hidden{display:none}
</style>
</head>

<body>

<div id="productModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-modal" onclick="document.getElementById('productModal').style.display='none'">&times;</span>
    <div class="modal-left">
      <div id="modalImg" class="img-box" style="width:100%; height: 300px;">üì¶</div>
    </div>
    <div class="modal-right">
      <h1 id="modalTitle" style="margin:0; font-size: 26px;">Nama Produk</h1>
      <div id="modalPrice" style="font-size: 34px; font-weight:800; color:var(--green); margin:10px 0">Rp 0</div>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border)">
        <span style="font-size: 13px; font-weight: bold; color: var(--muted)">Jumlah Pesanan (Bisa desimal)</span>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px;">
           <div class="qty-control">
             <button class="qty-btn" onclick="updateQty(-0.5)">-</button>
             <input id="modalQty" class="qty-input" type="number" step="0.01" value="1" oninput="updateSubtotal()">
             <button class="qty-btn" onclick="updateQty(0.5)">+</button>
           </div>
           <div style="text-align: right">
             <small style="color: var(--muted)">Subtotal</small><br>
             <b id="modalSubtotal" style="font-size: 18px; color: #333">Rp 0</b>
           </div>
        </div>
        <div id="modalStokInfo" style="font-size: 12px; color: var(--muted); margin-top: 5px;">Sisa Stok: 0</div>
      </div>
      <button id="modalAddBtn" style="margin-top:25px; font-size: 16px;">+ Tambah ke Keranjang</button>
    </div>
  </div>
</div>

<header>
  <div class="logo" onclick="location.reload()">üß∫ Kios Bersama</div>
  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="Cari barang..." onkeyup="filterBarang()">
  </div>
</header>

<div class="banner-slider">
  <div class="slide-track" id="slider">
    <div class="slide-img" id="banner0">Banner 1</div>
    <div class="slide-img" id="banner1">Banner 2</div>
    <div class="slide-img" id="banner2">Banner 3</div>
  </div>
</div>

<div class="cat-container" id="categoryBar">
  <div class="cat-pill active" onclick="setCategory('Semua')">Semua</div>
</div>

<div class="container">
  <div class="main-content">
    <div class="tabs">
      <button id="tabBuyer" class="active">üõí Belanja</button>
      <button id="tabSaran">üí° Saran</button>
      <button id="tabAdmin">üîê Admin</button>
    </div>

    <div id="viewBuyer">
      <div class="grid-produk" id="buyerList"></div>
    </div>

    <div id="viewSaran" class="hidden">
      <div class="card">
        <h3>üí° Kirim Saran</h3>
        <input id="saranNama" placeholder="Nama Anda">
        <textarea id="saranPesan" placeholder="Isi pesan..." style="height: 120px;"></textarea>
        <button onclick="kirimSaran()">Kirim</button>
      </div>
    </div>

    <div id="viewAdmin" class="hidden">
      <div class="card">
        <h3>üñºÔ∏è Banner Slider</h3>
        <input id="b0" placeholder="URL Banner 1">
        <input id="b1" placeholder="URL Banner 2">
        <input id="b2" placeholder="URL Banner 3">
        <button onclick="saveBanners()">Update Banner</button>
      </div>

      <div class="card">
        <h3>Tambah Barang</h3>
        <input id="nama" placeholder="Nama Barang">
        <input id="harga" type="text" placeholder="Harga">
        <input id="stok" type="number" step="0.01" placeholder="Stok">
        <div style="display: flex; gap: 5px;">
            <select id="satuan" style="flex:1"><option>Kg</option><option>Bungkus</option><option>Botol</option><option>Pcs</option></select>
            <input id="kategori" placeholder="Kategori" style="flex:1">
        </div>
        <input id="fotoUrl" placeholder="URL Foto">
        <button onclick="simpan()">Simpan Barang</button>
      </div>

      <div class="card">
        <h3>üì¶ Daftar Inventaris Barang</h3>
        <div id="adminList" style="max-height: 500px; overflow-y: auto;">
            </div>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="card cart-sticky">
      <h3>üõí Pesanan</h3>
      <div id="cart" style="font-size:13px; color:var(--muted); min-height:80px">Kosong</div>
      <div style="margin:15px 0; border-top:1px solid #eee; padding-top:10px">
        <b style="font-size: 20px; color: var(--green);">Total: Rp <span id="total">0</span></b>
      </div>
      <button onclick="checkout()">Pesan via WA</button>
    </div>
  </div>
</div>

<script>
const ADMIN_PW = "kios123";
const WA_NUMBER = "62811897005";
let adminUnlocked = false;
let BARANG = [];
let CART = {};
let currentModalItem = null;
let currentCat = "Semua";

firebase.initializeApp({
  apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
  authDomain: "kios-30.firebaseapp.com",
  projectId: "kios-30"
});
const db = firebase.firestore();

function cleanNum(v) {
  if (!v) return 0;
  return parseFloat(String(v).replace(/\./g, '').replace(/,/g, '')) || 0;
}

// DATA LOAD
db.collection("barang").onSnapshot(snap => {
  let list = [];
  let uniqueCats = new Set(["Semua"]);
  snap.forEach(doc => {
    const d = doc.data();
    list.push({ id: doc.id, ...d, harga: cleanNum(d.harga), stok: parseFloat(d.stok) || 0 });
    if(d.kategori) uniqueCats.add(d.kategori);
  });
  BARANG = list.sort((a,b) => a.nama.localeCompare(b.nama));
  renderCategories(Array.from(uniqueCats));
  renderBuyer();
  renderAdmin();
});

// RENDER ADMIN (VERSI LENGKAP SEBELUMNYA)
function renderAdmin() {
  const container = document.getElementById("adminList");
  container.innerHTML = "";
  if (BARANG.length === 0) container.innerHTML = "<small>Tidak ada barang.</small>";
  
  BARANG.forEach(b => {
    container.innerHTML += `
      <div class="admin-item-row">
        <img class="admin-img-thumb" src="${b.foto || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">
        <div class="admin-info">
            <b>${b.nama}</b>
            <span>Rp ${b.harga.toLocaleString()} | Stok: ${b.stok} ${b.satuan}</span>
        </div>
        <button class="danger" style="width:auto; padding:6px 12px; font-size:12px;" 
            onclick="if(confirm('Hapus ${b.nama}?')) db.collection('barang').doc('${b.id}').delete()">
            Hapus
        </button>
      </div>`;
  });
}

// LOGIKA MODAL & BELANJA
function openDetail(id) {
  const b = BARANG.find(x => x.id === id);
  if (!b) return;
  currentModalItem = b;
  document.getElementById("modalTitle").innerText = b.nama;
  document.getElementById("modalPrice").innerText = "Rp " + b.harga.toLocaleString('id-ID');
  document.getElementById("modalStokInfo").innerText = `Sisa Stok: ${b.stok} ${b.satuan}`;
  document.getElementById("modalImg").innerHTML = b.foto ? `<img src="${b.foto}">` : "üì¶";
  document.getElementById("modalQty").value = 1;
  updateSubtotal();
  document.getElementById("modalAddBtn").onclick = () => {
      const q = parseFloat(document.getElementById("modalQty").value);
      if(q > b.stok) return alert("Stok tidak cukup!");
      CART[id] = (CART[id] || 0) + q;
      renderCart();
      document.getElementById('productModal').style.display='none';
  };
  document.getElementById("productModal").style.display = "flex";
}

function updateQty(delta) {
  const i = document.getElementById("modalQty");
  let v = (parseFloat(i.value) || 0) + delta;
  if (v < 0.01) v = 0.01;
  if (v > currentModalItem.stok) v = currentModalItem.stok;
  i.value = v.toFixed(2);
  updateSubtotal();
}

function updateSubtotal() {
  const q = parseFloat(document.getElementById("modalQty").value) || 0;
  const p = currentModalItem ? currentModalItem.harga : 0;
  document.getElementById("modalSubtotal").innerText = "Rp " + (q * p).toLocaleString('id-ID');
}

function renderCart() {
  const c = document.getElementById("cart");
  c.innerHTML = ""; let t = 0;
  for (let id in CART) {
    const b = BARANG.find(x => x.id === id);
    if (!b) continue;
    let s = b.harga * CART[id]; t += s;
    c.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px">
      <span>${b.nama} (${CART[id]} ${b.satuan})</span>
      <span>Rp ${s.toLocaleString('id-ID')}</span>
    </div>`;
  }
  document.getElementById("total").innerText = t.toLocaleString('id-ID');
  if(t === 0) c.innerHTML = "Kosong";
}

function renderBuyer(f = "") {
  const container = document.getElementById("buyerList");
  container.innerHTML = "";
  let filtered = BARANG.filter(b => b.nama.toLowerCase().includes(f.toLowerCase()));
  if(currentCat !== "Semua") filtered = filtered.filter(b => b.kategori === currentCat);
  filtered.forEach(b => {
    container.innerHTML += `<div class="item-produk" onclick="openDetail('${b.id}')">
        <div class="img-box">${b.foto ? `<img src="${b.foto}">` : 'üì¶'}</div>
        <b>${b.nama}</b><div class="price">Rp ${b.harga.toLocaleString('id-ID')}</div>
        <div class="stok-tag">Stok: ${b.stok} ${b.satuan}</div>
    </div>`;
  });
}

// SIMPAN BARANG
function simpan() {
  const n = document.getElementById("nama"), h = document.getElementById("harga"),
        s = document.getElementById("stok"), sat = document.getElementById("satuan"),
        k = document.getElementById("kategori"), f = document.getElementById("fotoUrl");
  if(!n.value || !h.value) return alert("Nama & Harga wajib isi!");
  db.collection("barang").add({
    nama: n.value, harga: cleanNum(h.value), stok: parseFloat(s.value) || 0,
    satuan: sat.value, kategori: k.value, foto: f.value
  }).then(() => { n.value=h.value=s.value=f.value=""; alert("Tersimpan!"); });
}

// LAIN-LAIN
function showView(v) {
    ["viewBuyer", "viewSaran", "viewAdmin"].forEach(id => document.getElementById(id).classList.add("hidden"));
    ["tabBuyer", "tabSaran", "tabAdmin"].forEach(id => document.getElementById(id).classList.remove("active"));
    document.getElementById("view" + v).classList.remove("hidden");
    document.getElementById("tab" + v).classList.add("active");
}

tabBuyer.onclick = () => showView("Buyer");
tabSaran.onclick = () => showView("Saran");
tabAdmin.onclick = () => {
    if (!adminUnlocked) {
        if (prompt("Password:") !== ADMIN_PW) return;
        adminUnlocked = true;
    }
    showView("Admin");
};

function renderCategories(cats) {
    document.getElementById('categoryBar').innerHTML = cats.map(c => `<div class="cat-pill ${currentCat === c ? 'active' : ''}" onclick="setCategory('${c}')">${c}</div>`).join('');
}
function setCategory(cat) { currentCat = cat; renderBuyer(); }
function filterBarang() { renderBuyer(document.getElementById("searchInput").value); }
function closeModal(e) { if (e.target.id === "productModal") e.target.style.display = "none"; }

function saveBanners() {
    const urls = [document.getElementById('b0').value, document.getElementById('b1').value, document.getElementById('b2').value];
    db.collection("settings").doc("banners").set({urls}).then(() => alert("Banner Updated!"));
}

function checkout() {
  if (Object.keys(CART).length === 0) return alert("Kosong!");
  let m = `Pesanan Baru:%0A`;
  for (let id in CART) {
    const b = BARANG.find(x => x.id === id);
    m += `‚Ä¢ ${b.nama} (${CART[id]} ${b.satuan})%0A`;
  }
  m += `Total: Rp ${document.getElementById("total").innerText}`;
  window.open(`https://wa.me/${WA_NUMBER}?text=${m}`);
}

let slidePos = 0;
setInterval(() => {
    slidePos = (slidePos + 1) % 3;
    const s = document.getElementById('slider');
    if(s) s.style.transform = `translateX(-${slidePos * 33.33}%)`;
}, 4000);
</script>
</body>
</html>
