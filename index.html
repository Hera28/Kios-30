<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kios Bersama</title>

<!-- Firebase compat (AMAN & STABIL) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --primary:#22c55e;
  --muted:#94a3b8;
}
body.light{
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#64748b;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI;
  background:var(--bg);
  color:var(--text);
}
header{
  background:var(--primary);
  padding:16px;
  text-align:center;
  position:relative;
}
header h1{margin:0;font-size:1.4rem}
#theme{
  position:absolute;
  right:16px;
  top:16px;
  cursor:pointer;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  margin-bottom:16px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:var(--primary);
  color:white;
  font-size:1rem;
  cursor:pointer;
}
button.secondary{background:#64748b}
button.danger{background:#ef4444}
input,select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid #cbd5e1;
}
.hidden{display:none}
.item{
  border:1px solid #334155;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}
.flex{
  display:flex;
  gap:8px;
  margin-top:8px;
}
.flex button{flex:1}
.small{color:var(--muted);font-size:.85rem}
</style>
</head>

<body class="dark">

<header>
  <h1 id="title">ğŸ§º Kios Bersama</h1>
  <div id="theme">ğŸŒ™</div>
</header>

<div class="container">

<!-- HOME -->
<div id="home" class="card">
  <button onclick="openBuyer()">ğŸ›’ Pembeli</button>
  <button class="secondary" onclick="openLogin()">ğŸ” Admin</button>
</div>

<!-- LOGIN -->
<div id="login" class="card hidden">
  <input id="pass" type="password" placeholder="Password Admin">
  <button onclick="login()">Masuk</button>
  <button class="secondary" onclick="goHome()">Kembali</button>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>ğŸ“¦ Kelola Barang</h3>

  <input id="nama" placeholder="Nama barang">
  <input id="harga" type="number" placeholder="Harga">
  <input id="stok" type="number" placeholder="Stok">
  <select id="satuan">
    <option value="">Pilih satuan</option>
    <option>kg</option>
    <option>pcs</option>
    <option>dus</option>
    <option>lusin</option>
    <option>satuan</option>
  </select>

  <button onclick="simpan()">ğŸ’¾ Simpan Barang</button>

  <h4>ğŸ“‹ Daftar Barang</h4>
  <div id="adminList"></div>

  <button class="secondary" onclick="goHome()">Keluar</button>
</div>

<!-- BUYER -->
<div id="buyer" class="card hidden">
  <h3>ğŸ› Pilih Barang</h3>
  <div id="buyerList"></div>

  <div class="item">
    <b>ğŸ§¾ Keranjang</b>
    <div id="cart"></div>
    <b>Total: Rp <span id="total">0</span></b>
    <button onclick="checkout()">ğŸ“± Pesan via WhatsApp</button>
  </div>

  <button class="secondary" onclick="goHome()">Kembali</button>
</div>

</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
  authDomain: "kios-30.firebaseapp.com",
  projectId: "kios-30"
});
const db = firebase.firestore();

/* ================= CONFIG ================= */
const ADMIN_PASS = "11229911";
const WA = "62811897005";

/* ================= STATE ================= */
let BARANG = [];
let CART = {};
let editId = null;

/* ================= THEME ================= */
theme.onclick = () => {
  document.body.classList.toggle("light");
  localStorage.theme = document.body.classList.contains("light") ? "light" : "dark";
};
if(localStorage.theme === "light") document.body.classList.add("light");

/* ================= NAV ================= */
function show(id){
  ["home","login","admin","buyer"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function goHome(){show("home")}
function openLogin(){show("login")}
function openBuyer(){renderBuyer();show("buyer")}

/* ================= LOGIN ================= */
function login(){
  if(pass.value !== ADMIN_PASS) return alert("Password salah");
  show("admin");
}

/* ================= LISTENER (FIX UNDEFINED) ================= */
db.collection("barang").onSnapshot(snap=>{
  BARANG = [];
  snap.forEach(doc=>{
    const d = doc.data();

    // ğŸ”¥ FILTER DATA RUSAK / LAMA
    if(
      !d ||
      !d.nama ||
      d.harga === undefined ||
      d.stok === undefined ||
      !d.satuan
    ) return;

    BARANG.push({
      id: doc.id,
      nama: String(d.nama),
      harga: Number(d.harga),
      stok: Number(d.stok),
      satuan: String(d.satuan)
    });
  });
  renderAdmin();
  renderBuyer();
});

/* ================= CRUD ================= */
function simpan(){
  if(!nama.value || !harga.value || !stok.value || !satuan.value)
    return alert("Lengkapi data");

  const data = {
    nama: nama.value.trim(),
    harga: Number(harga.value),
    stok: Number(stok.value),
    satuan: satuan.value,
    ts: Date.now()
  };

  if(editId){
    db.collection("barang").doc(editId).set(data,{merge:true});
  }else{
    db.collection("barang").add(data);
  }

  editId=null;
  nama.value=harga.value=stok.value="";
}

function editBarang(id){
  const b = BARANG.find(x=>x.id===id);
  if(!b) return;
  editId=id;
  nama.value=b.nama;
  harga.value=b.harga;
  stok.value=b.stok;
  satuan.value=b.satuan;
}

function hapusBarang(id){
  if(confirm("Hapus barang?")){
    db.collection("barang").doc(id).delete();
  }
}

/* ================= RENDER ================= */
function renderAdmin(){
  adminList.innerHTML="";
  BARANG.forEach(b=>{
    adminList.innerHTML += `
    <div class="item">
      <b>${b.nama}</b><br>
      ${b.stok} ${b.satuan}<br>
      Rp ${b.harga}
      <div class="flex">
        <button onclick="editBarang('${b.id}')">âœ Edit</button>
        <button class="danger" onclick="hapusBarang('${b.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  });
}

function renderBuyer(){
  buyerList.innerHTML="";
  BARANG.forEach(b=>{
    buyerList.innerHTML += `
    <div class="item">
      <b>${b.nama}</b><br>
      Rp ${b.harga} / ${b.satuan} â€¢ Stok ${b.stok}
      <button onclick="addCart('${b.id}')">Tambah</button>
    </div>`;
  });
}

/* ================= CART ================= */
function addCart(id){
  CART[id] = (CART[id]||0)+1;
  renderCart();
}
function renderCart(){
  cart.innerHTML="";
  let total=0;
  for(let id in CART){
    const b = BARANG.find(x=>x.id===id);
    if(!b) continue;
    total += b.harga*CART[id];
    cart.innerHTML += `${b.nama} x ${CART[id]}<br>`;
  }
  totalEl.innerText = total;
}
const totalEl=document.getElementById("total");

/* ================= CHECKOUT ================= */
function checkout(){
  if(Object.keys(CART).length===0) return alert("Keranjang kosong");

  let msg="Halo, saya mau pesan:%0A";
  let total=0;

  for(let id in CART){
    const b=BARANG.find(x=>x.id===id);
    if(!b) continue;
    msg+=`* ${b.nama} ${CART[id]} ${b.satuan}%0A`;
    total+=b.harga*CART[id];
  }
  msg+=`Total: Rp ${total}`;
  window.open(`https://wa.me/${WA}?text=${msg}`);
}

/* ================= BACKDOOR TAP ================= */
let tap=0;
title.onclick=()=>{
  tap++;
  if(tap===5){
    tap=0;
    openLogin();
  }
};
</script>

</body>
</html>
