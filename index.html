<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kios Bersama - Enterprise Version 2.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* ==========================================================================
           1. CSS VARIABLES (Design System)
           ========================================================================== 
        */
        :root {
            --p: #00aa5b; /* Tokopedia Green */
            --p-dark: #00894a;
            --p-light: #e5f9f0;
            --bg: #f0f3f7;
            --card: #ffffff;
            --text: #2e3137;
            --muted: #6d7588;
            --border: #e5e7eb;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius-lg: 20px;
            --radius-md: 12px;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==========================================================================
           2. GLOBAL RESET
           ========================================================================== 
        */
        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* ==========================================================================
           3. HEADER & SEARCH NAVIGATION
           ========================================================================== 
        */
        header {
            background: var(--card);
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            position: sticky;
            top: 0;
            z-index: 1100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .brand-logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--p), var(--p-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 900;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 170, 91, 0.3);
        }

        .brand-name {
            font-size: 26px;
            font-weight: 800;
            color: var(--p);
            letter-spacing: -1px;
        }

        .search-wrapper {
            flex: 1;
            max-width: 600px;
            margin: 0 30px;
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border);
            background: #f8fafc;
            font-size: 16px;
            outline: none;
            transition: var(--transition);
        }

        .search-bar:focus {
            border-color: var(--p);
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 170, 91, 0.1);
        }

        .search-icon-abs {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 18px;
        }

        /* ==========================================================================
           4. MAIN CONTENT LAYOUT
           ========================================================================== 
        */
        .app-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 25px;
            display: grid;
            grid-template-columns: 240px 1fr 350px;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .app-container { grid-template-columns: 1fr 350px; }
            .left-sidebar { display: none; }
        }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .side-cart { position: static; }
        }

        /* ==========================================================================
           5. LEFT SIDEBAR (CATEGORIES)
           ========================================================================== 
        */
        .sidebar-nav {
            position: sticky;
            top: 110px;
        }

        .category-item {
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            font-weight: 600;
            color: var(--muted);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-item:hover {
            background: #eef2f6;
            color: var(--text);
        }

        .category-item.active {
            background: var(--p-light);
            color: var(--p);
        }

        /* ==========================================================================
           6. PRODUCT GRID & CARDS
           ========================================================================== 
        */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 25px;
        }

        .p-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 15px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 340px;
        }

        .p-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow);
            border-color: var(--p);
        }

        .p-img-box {
            width: 100%;
            aspect-ratio: 1/1;
            background: #f1f5f9;
            border-radius: 14px;
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .p-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .p-info .name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            height: 44px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .p-info .price {
            font-size: 20px;
            font-weight: 900;
            color: var(--p);
        }

        .p-tag {
            display: inline-block;
            background: #f1f3f5;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            color: var(--muted);
            margin-top: 10px;
        }

        /* ==========================================================================
           7. CART SYSTEM (SIDEBAR)
           ========================================================================== 
        */
        .cart-panel {
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 25px;
            position: sticky;
            top: 110px;
            box-shadow: var(--shadow);
        }

        .cart-items-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }

        .cart-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed var(--border);
        }

        .cart-item-info b { font-size: 14px; display: block; }
        .cart-item-info span { font-size: 12px; color: var(--muted); }

        .btn-remove {
            background: #fff1f2;
            color: var(--danger);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .total-display {
            background: var(--p-light);
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            text-align: center;
        }

        .total-display small { font-weight: bold; color: var(--p); text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        .total-display div { font-size: 32px; font-weight: 900; color: var(--p-dark); }

        .btn-order {
            background: var(--p);
            color: white;
            border: none;
            width: 100%;
            padding: 18px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-order:hover { background: var(--p-dark); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 170, 91, 0.3); }

        /* ==========================================================================
           8. MODAL SYSTEM
           ========================================================================== 
        */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-window {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 30px;
            padding: 40px;
            position: relative;
            animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .qty-stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .step-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 3px solid var(--p);
            background: white;
            color: var(--p);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .step-btn:hover { background: var(--p); color: white; }

        #qtyValue { font-size: 36px; font-weight: 900; min-width: 60px; text-align: center; }

        /* ==========================================================================
           9. ADMIN DASHBOARD & FORMS
           ========================================================================== 
        */
        .admin-view { display: none; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-card h4 { margin: 0; color: var(--muted); font-size: 13px; }
        .stat-card p { margin: 5px 0 0; font-size: 24px; font-weight: 800; color: var(--p); }

        .form-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 2px solid var(--border);
            margin-bottom: 30px;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 800; font-size: 13px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid var(--border);
            font-size: 15px;
            outline: none;
            transition: var(--transition);
        }

        .form-input:focus { border-color: var(--p); }

        .inv-row {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .inv-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; margin-right: 15px; }

        .hidden { display: none !important; }

        /* UTILITIES */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mt-20 { margin-top: 20px; }
        .text-center { text-align: center; }

    </style>
</head>
<body>

    <header>
        <div class="brand-area" onclick="location.reload()">
            <div class="brand-logo">K</div>
            <div class="brand-name">Kios Bersama</div>
        </div>
        
        <div class="search-wrapper">
            <span class="search-icon-abs">üîç</span>
            <input type="text" id="masterSearch" class="search-bar" placeholder="Cari beras, minyak, kecap..." onkeyup="processRender()">
        </div>

        <div class="nav-buttons">
            <button id="btnShop" onclick="switchView('B')" style="padding: 12px 20px; border-radius: 10px; border: none; background: var(--p); color: white; font-weight: bold; cursor: pointer;">üõçÔ∏è Belanja</button>
            <button id="btnAdmin" onclick="switchView('A')" style="padding: 12px 20px; border-radius: 10px; border: 2px solid var(--border); background: white; font-weight: bold; cursor: pointer; margin-left: 10px;">üîê Admin</button>
        </div>
    </header>

    <div class="app-container">
        <aside class="left-sidebar">
            <div class="sidebar-nav">
                <h3 style="padding: 0 18px; font-size: 14px; color: var(--muted);">KATEGORI POPULER</h3>
                <div class="category-item active" onclick="filterCat('all')">üì¶ Semua Produk</div>
                <div class="category-item" onclick="filterCat('beras')">üçö Beras & Sembako</div>
                <div class="category-item" onclick="filterCat('minyak')">üõ¢Ô∏è Minyak & Lemak</div>
                <div class="category-item" onclick="filterCat('kecap')">üçØ Kecap & Saos</div>
                <div class="category-item" onclick="filterCat('sabun')">üßº Sabun & Cuci</div>
                <div class="category-item" onclick="filterCat('mie')">üçú Mie Instan</div>
            </div>
        </aside>

        <main class="content-area">
            
            <div id="shopView">
                <div class="product-grid" id="productGrid">
                    </div>
            </div>

            <div id="adminView" class="hidden">
                <div class="admin-grid mb-30">
                    <div class="stat-card">
                        <h4>TOTAL PRODUK</h4>
                        <p id="statTotalItems">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>ESTIMASI NILAI ASET</h4>
                        <p id="statTotalValue">Rp 0</p>
                    </div>
                </div>

                <div class="form-box">
                    <h3 style="margin-top:0">INPUT DATA BARANG</h3>
                    <div class="admin-grid">
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Nama Produk (Gunakan nama yang sama untuk Update)</label>
                            <input type="text" id="inName" class="form-input" placeholder="Contoh: Kecap ABC 520ml">
                        </div>
                        <div class="form-group">
                            <label>Harga Jual (Rp)</label>
                            <input type="number" id="inPrice" class="form-input" placeholder="15000">
                        </div>
                        <div class="form-group">
                            <label>Stok Gudang</label>
                            <input type="number" id="inStock" class="form-input" placeholder="24">
                        </div>
                        <div class="form-group">
                            <label>Satuan Barang</label>
                            <input type="text" id="inUnit" class="form-input" placeholder="Pcs / Botol / Kg">
                        </div>
                        <div class="form-group">
                            <label>URL Link Foto</label>
                            <input type="text" id="inPhoto" class="form-input" placeholder="https://link-foto.com/gambar.jpg">
                        </div>
                    </div>
                    <button class="btn-order" onclick="actionSaveData()">üöÄ Simpan ke Database</button>
                </div>

                <div id="adminInventoryList">
                    </div>
            </div>
        </main>

        <aside class="side-cart">
            <div class="cart-panel">
                <div class="flex-between">
                    <h3 style="margin:0">üõí Keranjang</h3>
                    <span id="cartCountBadge" style="background: var(--p); color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px; font-weight: bold;">0</span>
                </div>
                
                <div id="cartItemsList" class="cart-items-container">
                    <div class="text-center" style="padding: 40px 0; color: var(--muted);">
                        <div style="font-size: 40px;">üõçÔ∏è</div>
                        <p>Keranjang kamu masih kosong nih!</p>
                    </div>
                </div>

                <div class="total-display">
                    <small>Total yang harus dibayar</small>
                    <div id="displayGrandTotal">Rp 0</div>
                </div>

                <button class="btn-order" onclick="actionCheckoutWA()">
                    <span>Konfirmasi via WhatsApp</span>
                    <span>‚ûú</span>
                </button>
                
                <p style="font-size: 11px; color: var(--muted); text-align: center; margin-top: 15px;">
                    *Harga belum termasuk ongkos kirim (jika ada).
                </p>
            </div>
        </aside>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="actionCloseModal()">
        <div class="modal-window" onclick="event.stopPropagation()">
            <div id="modalImgFrame" class="p-img-box" style="height: 250px; margin-bottom: 25px;"></div>
            <h2 id="modalTitle" style="margin: 0; font-size: 24px;"></h2>
            <div id="modalPriceLabel" style="font-size: 28px; font-weight: 900; color: var(--p); margin: 5px 0;"></div>
            <div id="modalStockLabel" style="color: var(--muted); font-size: 14px; margin-bottom: 20px;"></div>

            <div style="border-top: 2px solid #f1f5f9; padding-top: 25px;">
                <div style="text-align: center; font-weight: 800; color: var(--muted); font-size: 12px; letter-spacing: 1px;">ATUR JUMLAH PESANAN</div>
                <div class="qty-stepper">
                    <button class="step-btn" onclick="logicChangeQty(-1)">‚àí</button>
                    <div id="qtyValue">1</div>
                    <button class="step-btn" onclick="logicChangeQty(1)">+</button>
                </div>
            </div>

            <div class="flex-between mt-20" style="padding: 20px; background: #f8fafc; border-radius: 15px;">
                <span style="font-weight: bold; color: var(--muted);">SUBTOTAL</span>
                <b id="modalSubtotal" style="font-size: 24px; color: var(--p-dark);">Rp 0</b>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 25px;">
                <button class="btn-order" onclick="logicAddToCart()"> Tambahkan ke Keranjang</button>
                <button onclick="actionBuyDirect()" style="background: none; border: 2px solid var(--p); color: var(--p); padding: 15px; border-radius: 15px; font-weight: 800; cursor: pointer;">Beli Sekarang</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCpRbMAIyfJzpzi5iC4xljFt_gyXaJ5Yw",
            authDomain: "kios-30.firebaseapp.com",
            projectId: "kios-30"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. GLOBAL STATE ---
        let DB_PRODUCTS = [];
        let LOCAL_CART = {};
        let ACTIVE_PID = null;
        let ACTIVE_QTY = 1;
        let CURRENT_FILTER = 'all';

        // --- 3. DATA FETCHING (REALTIME) ---
        /**
         * Mengambil data secara realtime dari Firestore.
         * Menggunakan listener onSnapshot agar perubahan stok langsung terlihat.
         */
        function initDataSync() {
            db.collection("barang").onSnapshot(snapshot => {
                DB_PRODUCTS = [];
                let totalValue = 0;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if (d.nama) {
                        const item = {
                            id: doc.id,
                            nama: d.nama,
                            harga: parseInt(d.harga) || 0,
                            stok: parseFloat(d.stok) || 0,
                            satuan: d.satuan || "pcs",
                            foto: d.foto || ""
                        };
                        DB_PRODUCTS.push(item);
                        totalValue += (item.harga * item.stok);
                    }
                });

                // Update Admin Stats
                document.getElementById('statTotalItems').innerText = DB_PRODUCTS.length;
                document.getElementById('statTotalValue').innerText = 'Rp ' + totalValue.toLocaleString('id-ID');
                
                processRender();
            }, error => {
                console.error("Firestore Sync Error:", error);
                alert("Gagal memuat data dari database. Silakan periksa koneksi internet.");
            });
        }

        // --- 4. CORE RENDERING ENGINE ---
        /**
         * Fungsi utama untuk menampilkan produk ke layar.
         * Menangani fitur Search, Filter Kategori, dan Admin List.
         */
        function processRender() {
            const grid = document.getElementById('productGrid');
            const invList = document.getElementById('adminInventoryList');
            const searchVal = document.getElementById('masterSearch').value.toLowerCase();
            
            grid.innerHTML = '';
            invList.innerHTML = '<h3 style="margin: 30px 0 15px;">DAFTAR INVENTARIS</h3>';

            // Sorting Produk (Abjad A-Z)
            const sortedProducts = DB_PRODUCTS.sort((a, b) => a.nama.localeCompare(b.nama));

            sortedProducts.forEach(product => {
                const matchSearch = product.nama.toLowerCase().includes(searchVal);
                const matchFilter = (CURRENT_FILTER === 'all' || product.nama.toLowerCase().includes(CURRENT_FILTER));

                if (matchSearch && matchFilter) {
                    // Render Buyer Card
                    grid.innerHTML += `
                        <div class="p-card" onclick="actionOpenModal('${product.id}')">
                            <div class="p-img-box">
                                <img src="${product.foto || 'https://via.placeholder.com/200?text=Kios+Bersama'}" 
                                     onload="this.style.opacity=1" 
                                     onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                            </div>
                            <div class="p-info">
                                <div class="name">${product.nama}</div>
                                <div class="price">Rp ${product.harga.toLocaleString('id-ID')}</div>
                                <div class="p-tag">Stok: ${product.stok} ${product.satuan}</div>
                            </div>
                        </div>
                    `;

                    // Render Admin Row
                    invList.innerHTML += `
                        <div class="inv-row">
                            <img src="${product.foto}" class="inv-img" onerror="this.src='https://via.placeholder.com/50'">
                            <div style="flex:1">
                                <b style="font-size:15px">${product.nama}</b><br>
                                <small style="color:var(--muted)">Rp ${product.harga.toLocaleString()} | ${product.stok} ${product.satuan}</small>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button onclick="actionDeleteProduct('${product.id}')" style="background:#fff1f2; color:var(--danger); border:none; padding:8px 12px; border-radius:8px; font-weight:bold; cursor:pointer">HAPUS</button>
                            </div>
                        </div>
                    `;
                }
            });

            if (grid.innerHTML === '') {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 50px; color: var(--muted);">
                    <h3>Produk tidak ditemukan</h3>
                    <p>Coba gunakan kata kunci lain.</p>
                </div>`;
            }
        }

        // --- 5. MODAL & INTERACTION LOGIC ---
        function actionOpenModal(id) {
            const p = DB_PRODUCTS.find(x => x.id === id);
            ACTIVE_PID = id;
            ACTIVE_QTY = 1;

            document.getElementById('modalTitle').innerText = p.nama;
            document.getElementById('modalPriceLabel').innerText = 'Rp ' + p.harga.toLocaleString('id-ID');
            document.getElementById('modalStockLabel').innerText = `Tersedia: ${p.stok} ${p.satuan}`;
            document.getElementById('modalImgFrame').innerHTML = `<img src="${p.foto || 'https://via.placeholder.com/250'}" style="width:100%; height:100%; object-fit:cover; opacity:1">`;
            document.getElementById('qtyValue').innerText = ACTIVE_QTY;
            
            logicUpdateSubtotal();
            document.getElementById('modalOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Lock scroll
        }

        function actionCloseModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function logicChangeQty(delta) {
            const p = DB_PRODUCTS.find(x => x.id === ACTIVE_PID);
            const newQty = ACTIVE_QTY + delta;
            
            if (newQty >= 1 && newQty <= p.stok) {
                ACTIVE_QTY = newQty;
                document.getElementById('qtyValue').innerText = ACTIVE_QTY;
                logicUpdateSubtotal();
            } else if (newQty > p.stok) {
                alert(`Maaf, stok ${p.nama} hanya tersedia ${p.stok} ${p.satuan}`);
            }
        }

        function logicUpdateSubtotal() {
            const p = DB_PRODUCTS.find(x => x.id === ACTIVE_PID);
            const subtotal = p.harga * ACTIVE_QTY;
            document.getElementById('modalSubtotal').innerText = 'Rp ' + subtotal.toLocaleString('id-ID');
        }

        // --- 6. SHOPPING CART CORE ---
        function logicAddToCart() {
            LOCAL_CART[ACTIVE_PID] = (LOCAL_CART[ACTIVE_PID] || 0) + ACTIVE_QTY;
            actionRenderCart();
            actionCloseModal();
            
            // Notification (Simple alert replaced by UI feedback in pro apps)
            console.log("Added to cart:", ACTIVE_PID);
        }

        function actionRenderCart() {
            const container = document.getElementById('cartItemsList');
            const totalDisp = document.getElementById('displayGrandTotal');
            const badge = document.getElementById('cartCountBadge');
            let grandTotal = 0;
            let itemCount = 0;

            container.innerHTML = '';
            const ids = Object.keys(LOCAL_CART);

            if (ids.length === 0) {
                container.innerHTML = `<div class="text-center" style="padding: 40px 0; color: var(--muted);"><div style="font-size: 40px;">üõçÔ∏è</div><p>Keranjang kamu masih kosong nih!</p></div>`;
                totalDisp.innerText = 'Rp 0';
                badge.innerText = '0';
                return;
            }

            ids.forEach(id => {
                const p = DB_PRODUCTS.find(x => x.id === id);
                if (p) {
                    const sub = p.harga * LOCAL_CART[id];
                    grandTotal += sub;
                    itemCount += LOCAL_CART[id];
                    
                    container.innerHTML += `
                        <div class="cart-item-row">
                            <div class="cart-item-info">
                                <b>${p.nama}</b>
                                <span>${LOCAL_CART[id]} x Rp ${p.harga.toLocaleString()}</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:12px">
                                <b style="color:var(--p)">Rp ${sub.toLocaleString()}</b>
                                <button class="btn-remove" onclick="logicRemoveFromCart('${id}')">√ó</button>
                            </div>
                        </div>
                    `;
                }
            });

            totalDisp.innerText = 'Rp ' + grandTotal.toLocaleString('id-ID');
            badge.innerText = itemCount;
        }

        function logicRemoveFromCart(id) {
            delete LOCAL_CART[id];
            actionRenderCart();
        }

        // --- 7. EXTERNAL INTEGRATION (WHATSAPP) ---
        function actionCheckoutWA() {
            const ids = Object.keys(LOCAL_CART);
            if (ids.length === 0) return alert("Keranjang kamu kosong!");

            let message = "Halo Kios Bersama! üëã\nSaya ingin memesan barang berikut:\n\n";
            let total = 0;

            ids.forEach(id => {
                const p = DB_PRODUCTS.find(x => x.id === id);
                const sub = p.harga * LOCAL_CART[id];
                total += sub;
                message += `‚úÖ *${p.nama}*\n   Jml: ${LOCAL_CART[id]} ${p.satuan}\n   Sub: Rp ${sub.toLocaleString()}\n\n`;
            });

            message += `----------------------------\nüí∞ *TOTAL PEMBAYARAN: Rp ${total.toLocaleString()}*\n----------------------------\n\nMohon informasi ketersediaan stok dan total ongkirnya ya. Terima kasih! üôè`;

            const waLink = `https://wa.me/62811897005?text=${encodeURIComponent(message)}`;
            window.open(waLink, '_blank');
        }

        function actionBuyDirect() {
            const p = DB_PRODUCTS.find(x => x.id === ACTIVE_PID);
            const sub = p.harga * ACTIVE_QTY;
            let message = `Halo Kios Bersama! üëã\nSaya ingin beli langsung:\n\nüî• *${p.nama}*\nJml: ${ACTIVE_QTY} ${p.satuan}\nTotal: *Rp ${sub.toLocaleString()}*\n\nTerima kasih!`;
            
            const waLink = `https://wa.me/62811897005?text=${encodeURIComponent(message)}`;
            window.open(waLink, '_blank');
        }

        // --- 8. ADMIN ENGINE (DATABASE WRITE) ---
        async function actionSaveData() {
            const name = document.getElementById('inName').value.trim();
            const price = parseInt(document.getElementById('inPrice').value);
            const stock = parseFloat(document.getElementById('inStock').value);
            const unit = document.getElementById('inUnit').value.trim() || "pcs";
            const photo = document.getElementById('inPhoto').value.trim();

            if (!name || !price) return alert("Mohon lengkapi Nama dan Harga!");

            // Check for duplication (Smart Update)
            const existing = DB_PRODUCTS.find(x => x.nama.toLowerCase() === name.toLowerCase());

            try {
                if (existing) {
                    if (confirm(`Produk "${name}" sudah ada. Anda ingin mengupdate harga/stok?`)) {
                        await db.collection("barang").doc(existing.id).update({
                            harga: price,
                            stok: stock,
                            satuan: unit,
                            foto: photo || existing.foto
                        });
                        alert("Data Berhasil Diupdate!");
                    }
                } else {
                    await db.collection("barang").add({
                        nama: name,
                        harga: price,
                        stok: stock,
                        satuan: unit,
                        foto: photo
                    });
                    alert("Produk Baru Ditambahkan!");
                }
                
                // Reset Form
                document.querySelectorAll('.form-input').forEach(input => input.value = '');
            } catch (err) {
                console.error("Save Error:", err);
                alert("Gagal menyimpan data ke Firebase.");
            }
        }

        async function actionDeleteProduct(id) {
            if (confirm("Hapus produk ini secara permanen dari database?")) {
                try {
                    await db.collection("barang").doc(id).delete();
                } catch (err) {
                    alert("Gagal menghapus data.");
                }
            }
        }

        // --- 9. UTILITIES & NAVIGATION ---
        function switchView(mode) {
            const shop = document.getElementById('shopView');
            const admin = document.getElementById('adminView');
            const sidebar = document.querySelector('.left-sidebar');
            const bShop = document.getElementById('btnShop');
            const bAdmin = document.getElementById('btnAdmin');

            if (mode === 'A') {
                const pass = prompt("Masukkan Password Keamanan Admin:");
                if (pass === "kios123") {
                    shop.classList.add('hidden');
                    sidebar.classList.add('hidden');
                    admin.classList.remove('hidden');
                    bAdmin.style.background = 'var(--p)';
                    bAdmin.style.color = 'white';
                    bShop.style.background = 'white';
                    bShop.style.color = 'var(--text)';
                } else {
                    alert("Akses Ditolak! Password Salah.");
                }
            } else {
                shop.classList.remove('hidden');
                sidebar.classList.remove('hidden');
                admin.classList.add('hidden');
                bShop.style.background = 'var(--p)';
                bShop.style.color = 'white';
                bAdmin.style.background = 'white';
                bAdmin.style.color = 'var(--text)';
            }
        }

        function filterCat(cat) {
            CURRENT_FILTER = cat;
            document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            processRender();
        }

        // --- 10. BOOTSTRAP APP ---
        window.onload = initDataSync;

    </script>
</body>
</html>
